<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æŒ‡ä»¤ä¼˜åŒ– - AI æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        .bg-grid-pattern {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .tab-active {
            background: rgba(255, 255, 255, 0.9);
            color: #4f46e5;
            box-shadow: 0 4px 12px -2px rgba(79, 70, 229, 0.15);
            border-color: #e0e7ff;
        }

        .tab-inactive {
            color: #64748b;
            border-color: transparent;
        }

        .tab-inactive:hover {
            background: rgba(255, 255, 255, 0.5);
            color: #475569;
        }

        /* Modal Styles */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .modal-content {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        /* Image Generation Styles */
        .image-preview-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .image-preview-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -8px rgba(0, 0, 0, 0.15);
        }

        .image-preview-card img {
            transition: transform 0.5s ease;
        }

        .image-preview-card:hover img {
            transform: scale(1.05);
        }
    </style>
</head>

<body
    class="bg-slate-50 text-slate-800 min-h-screen font-sans selection:bg-indigo-100 selection:text-indigo-700 overflow-x-hidden">

    <!-- Ambient Background Effects -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full bg-grid-pattern opacity-[0.4]"></div>
        <div
            class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob">
        </div>
        <div
            class="absolute top-0 -right-4 w-72 h-72 bg-indigo-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000">
        </div>
        <div
            class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000">
        </div>
    </div>

    <!-- Navbar -->
    <header class="sticky top-0 z-50 transition-all duration-300 border-b border-white/40 bg-white/70 backdrop-blur-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg blur opacity-25 group-hover:opacity-50 transition duration-200">
                    </div>
                    <div
                        class="relative w-9 h-9 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white shadow-lg">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                    </div>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900">
                        æç¤ºè¯ä¼˜åŒ–
                    </h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div
                    class="text-xs font-medium px-3 py-1 rounded-full bg-indigo-50 text-indigo-600 border border-indigo-100 hidden sm:block">
                    AI Prompt Optimizer
                </div>
                <button id="btn-open-settings"
                    class="p-2.5 rounded-xl bg-white border border-slate-200 text-slate-600 hover:text-indigo-600 hover:border-indigo-100 hover:bg-indigo-50 transition-all shadow-sm flex items-center gap-2 group">
                    <i data-lucide="settings"
                        class="w-5 h-5 group-hover:rotate-90 transition-transform duration-500"></i>
                    <span class="text-sm font-semibold hidden sm:inline">é…ç½®</span>
                </button>
            </div>
        </div>
    </header>

    <main class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 animate-fade-in-up">

        <!-- Module Tabs -->
        <div
            class="flex items-center gap-2 mb-6 p-1 bg-slate-200/40 backdrop-blur-md rounded-2xl w-fit border border-white/40">
            <button id="tab-prompt-helper"
                class="tab-inactive px-6 py-2.5 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center gap-2 border">
                <i data-lucide="sparkles" class="w-4 h-4"></i>
                æç¤ºè¯å¸®å†™
            </button>
            <button id="tab-instruction"
                class="tab-active px-6 py-2.5 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center gap-2 border">
                <i data-lucide="binary" class="w-4 h-4"></i>
                æŒ‡ä»¤ä¼˜åŒ–
            </button>
            <button id="tab-image-reverse"
                class="tab-inactive px-6 py-2.5 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center gap-2 border">
                <i data-lucide="image" class="w-4 h-4"></i>
                å›¾åƒåæ¨
            </button>
            <button id="tab-instruction-reverse"
                class="tab-inactive px-6 py-2.5 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center gap-2 border">
                <i data-lucide="layers" class="w-4 h-4"></i>
                æŒ‡ä»¤åæ¨
            </button>
        </div>

        <div id="module-container">
            <!-- Prompt Helper Module -->
            <div id="view-prompt-helper" class="hidden grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-8 space-y-6">
                    <div
                        class="glass-panel rounded-2xl shadow-xl shadow-indigo-100/50 overflow-hidden flex flex-col self-start min-h-[600px]">
                        <div class="h-1.5 w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/40">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="font-bold text-slate-800 text-lg tracking-tight">æç¤ºè¯å¸®å†™å·¥ä½œå°</h2>
                                    <p class="text-xs text-slate-500 font-medium">Generate a structured prompt</p>
                                </div>
                            </div>
                        </div>
                        <div
                            class="flex-1 grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200/60">
                            <div class="flex flex-col bg-white/30 p-1">
                                <div
                                    class="px-5 py-3 flex justify-between items-center bg-gradient-to-r from-slate-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
                                        <i data-lucide="message-square" class="w-3.5 h-3.5 text-indigo-500"></i> åŸå§‹è¾“å…¥
                                    </span>
                                    <div class="flex items-center gap-3">
                                        <button id="btn-clear-input-helper"
                                            class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                                            title="æ¸…ç©ºè¾“å…¥">
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <span id="char-count-helper"
                                            class="text-xs font-mono text-slate-500 bg-slate-100/80 px-2.5 py-1 rounded-md font-semibold">0
                                            å­—ç¬¦</span>
                                    </div>
                                </div>
                                <div class="px-5 pb-5 relative h-[28rem] min-h-[28rem] max-h-[28rem]">
                                    <textarea id="input-prompt-helper" placeholder="æè¿°ä½ æƒ³è®© AI å¸®ä½ å†™çš„æç¤ºè¯ç›®æ ‡..."
                                        class="w-full h-full box-border p-4 resize-none bg-white border-2 border-slate-200 rounded-xl text-slate-700 font-mono text-sm leading-relaxed placeholder:text-slate-400 outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 transition-all shadow-sm"></textarea>
                                </div>
                            </div>
                            <div class="flex flex-col bg-slate-50/50 p-1 relative overflow-hidden">
                                <div
                                    class="px-5 py-3 flex justify-between items-center z-10 bg-gradient-to-r from-emerald-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-emerald-600 uppercase tracking-wider flex items-center gap-1.5">
                                        <span id="output-indicator-helper"
                                            class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse hidden shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                                        <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i> ä¼˜åŒ–åçš„æç¤ºè¯
                                    </span>
                                    <div class="flex items-center gap-3">
                                        <span id="output-char-count-helper"
                                            class="text-xs font-mono text-slate-500 bg-slate-100/80 px-2.5 py-1 rounded-md font-semibold">0 å­—ç¬¦</span>
                                        <button id="btn-copy-helper" disabled
                                            class="group text-xs flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-100 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                                            <i data-lucide="copy"
                                                class="w-3.5 h-3.5 group-hover:scale-110 transition-transform"></i>
                                            <span id="copy-text-helper">å¤åˆ¶</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="px-5 pb-5 relative z-10">
                                    <textarea id="output-prompt-helper" readonly
                                        class="w-full min-h-[12rem] h-auto box-border p-4 resize-none bg-white border-2 border-slate-200/80 rounded-xl text-slate-800 font-mono text-sm leading-relaxed outline-none focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-400 transition-all shadow-sm hidden"></textarea>
                                    <div id="output-placeholder-helper"
                                        class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none p-8 text-center">
                                        <div
                                            class="w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center mb-4 shadow-inner">
                                            <i data-lucide="sparkles" class="w-10 h-10 opacity-30 text-slate-400"></i>
                                        </div>
                                        <p class="text-sm font-medium text-slate-400 mb-1">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä¼˜åŒ–</p>
                                        <p class="text-xs text-slate-300">è¾“å…¥å†…å®¹åç‚¹å‡»"å¼€å§‹å¸®å†™"æŒ‰é’®</p>
                                    </div>
                                </div>
                                <div
                                    class="absolute bottom-0 right-0 w-64 h-64 bg-emerald-500/5 rounded-full filter blur-3xl pointer-events-none">
                                </div>
                            </div>
                        </div>
                        <div
                            class="p-6 bg-gradient-to-r from-white to-slate-50/50 border-t border-slate-100 flex justify-center relative z-20">
                            <button id="btn-optimize-helper" disabled
                                class="group relative inline-flex items-center justify-center gap-3 px-12 py-4 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white rounded-xl font-bold text-sm shadow-xl shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:-translate-y-0.5 active:translate-y-0 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0 overflow-hidden">
                                <div
                                    class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out">
                                </div>
                                <i id="icon-optimize-helper" data-lucide="sparkles" class="w-5 h-5 relative z-10"></i>
                                <i id="icon-loading-helper" data-lucide="loader-2"
                                    class="w-5 h-5 animate-spin hidden relative z-10"></i>
                                <span id="btn-text-helper" class="relative z-10">å¼€å§‹å¸®å†™</span>
                                <i id="icon-arrow-helper" data-lucide="arrow-right"
                                    class="w-4 h-4 group-hover:translate-x-1 transition-transform relative z-10"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Prompt Helper Reasoning Card -->
                    <div id="reasoning-card-helper"
                        class="hidden glass-panel rounded-2xl shadow-xl shadow-indigo-100/50 overflow-hidden mt-6 animate-fade-in-up">
                        <div class="p-5 border-b border-slate-100 bg-white/40 flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-lg bg-amber-50 border border-amber-100 flex items-center justify-center text-amber-600">
                                <i data-lucide="lightbulb" class="w-4 h-4"></i>
                            </div>
                            <h3 class="font-bold text-slate-800 text-sm">ä¼˜åŒ–æ€è·¯</h3>
                            <button id="btn-copy-reasoning-helper"
                                class="ml-auto text-xs flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-100">
                                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                <span>å¤åˆ¶</span>
                            </button>
                        </div>
                        <div class="p-6 bg-white/30 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap"
                            id="reasoning-content-helper"></div>
                    </div>
                </div>
                <div class="lg:col-span-4 space-y-6">
                    <!-- Usage Stats Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">ä½¿ç”¨äººæ•°</h3>
                                <p class="text-xs text-slate-500">ç»Ÿè®¡æ•°æ®</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-blue-700 uppercase tracking-wider">æ€»ä½¿ç”¨æ¬¡æ•°</span>
                                </div>
                                <p class="usage-count-display text-2xl font-bold text-slate-800 mb-2">0</p>
                                <p class="text-[11px] text-slate-400">å½“å‰æ˜¾ç¤ºä¸ºæœ¬è®¾å¤‡ç´¯è®¡ï¼Œåç«¯æ¥å…¥åæ±‡æ€»æ‰€æœ‰ IP</p>

                            </div>
                        </div>
                    </div>

                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-purple-50 flex items-center justify-center text-purple-600">
                                <i data-lucide="bookmark" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">å½“å‰é¢„è®¾</h3>
                                <p class="text-xs text-slate-500">å¸®å†™ç­–ç•¥</p>
                            </div>
                        </div>
                        <div id="current-preset-display-helper" class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-indigo-700 uppercase tracking-wider">é¢„è®¾åç§°</span>
                                    <button id="btn-open-settings-from-sidebar-helper"
                                        class="text-xs text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1">
                                        <i data-lucide="settings" class="w-3 h-3"></i>
                                        ç®¡ç†
                                    </button>
                                </div>
                                <p id="preset-name-display-helper" class="text-sm font-semibold text-slate-800 mb-2">
                                    ç»“æ„åŒ–å¸®å†™</p>
                                <p id="preset-preview-helper"
                                    class="text-xs text-slate-600 line-clamp-3 leading-relaxed">æ ¹æ®åŸå§‹è¾“å…¥ï¼Œç”Ÿæˆç»“æ„æ¸…æ™°ã€å¯å¤ç”¨çš„æç¤ºè¯è‰ç¨¿ã€‚
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center text-amber-600">
                                <i data-lucide="lightbulb" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">å¸®å†™å»ºè®®</h3>
                                <p class="text-xs text-slate-500">ä½¿ç”¨å»ºè®®</p>
                            </div>
                        </div>
                        <div id="tips-content-helper" class="space-y-3 text-xs text-slate-600">
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>ç®€è¿°ç›®æ ‡ä¸å—ä¼—ï¼Œé¿å…æ— æ•ˆä¿¡æ¯</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>ä¸ºè¾“å‡ºæŒ‡å®šé£æ ¼ã€æ ¼å¼å’Œé•¿åº¦</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Normal Prompt Optimization (Existing) -->
            <div id="view-prompt" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Main Workspace (Left) -->
                <div class="lg:col-span-8 space-y-6">
                    <div
                        class="glass-panel rounded-2xl shadow-xl shadow-indigo-100/50 overflow-hidden flex flex-col self-start min-h-[600px]">
                        <!-- Header Strip -->
                        <div class="h-1.5 w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>

                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/40">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm">
                                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="font-bold text-slate-800 text-lg tracking-tight" id="workbench-title">
                                        ä¼˜åŒ–å·¥ä½œå°</h2>
                                    <p class="text-xs text-slate-500 font-medium" id="workbench-subtitle">Design your
                                        prompt logic</p>
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex-1 grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200/60">
                            <!-- Input Section -->
                            <div class="flex flex-col bg-white/30 p-1">
                                <div
                                    class="px-5 py-3 flex justify-between items-center bg-gradient-to-r from-slate-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
                                        <i data-lucide="message-square" class="w-3.5 h-3.5 text-indigo-500"></i> åŸå§‹è¾“å…¥
                                    </span>
                                    <div class="flex items-center gap-3">
                                        <button id="btn-clear-input"
                                            class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                                            title="æ¸…ç©ºè¾“å…¥">
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <span id="char-count"
                                            class="text-xs font-mono text-slate-500 bg-slate-100/80 px-2.5 py-1 rounded-md font-semibold">0
                                            å­—ç¬¦</span>
                                    </div>
                                </div>
                                <div class="px-5 pb-5 relative h-[28rem] min-h-[28rem] max-h-[28rem]">
                <textarea id="input-prompt"
                                        placeholder="æè¿°ä½ å¸Œæœ› AI åšä»€ä¹ˆ...&#10;&#10;ğŸ’¡ æç¤ºï¼š&#10;â€¢ å†™ä¸€ä¸ª Python è„šæœ¬æ¥æŠ“å–ç½‘ç«™æ•°æ®&#10;â€¢ å¸®æˆ‘ä¼˜åŒ–è¿™æ®µä»£ç çš„æ€§èƒ½&#10;â€¢ åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ³¨å†Œè¡¨å•çš„éªŒè¯é€»è¾‘"
                    class="w-full h-full box-border p-4 resize-none bg-white border-2 border-slate-200 rounded-xl text-slate-700 font-mono text-sm leading-relaxed placeholder:text-slate-400 placeholder:font-normal outline-none focus:ring-2 focus:ring-indigo-500/30 focus:border-indigo-400 transition-all shadow-sm hover:border-slate-300"></textarea>
                                </div>
                            </div>

                            <!-- Output Section -->
                            <div class="flex flex-col bg-slate-50/50 p-1 relative overflow-hidden">
                                <div
                                    class="px-5 py-3 flex justify-between items-center z-10 bg-gradient-to-r from-emerald-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-emerald-600 uppercase tracking-wider flex items-center gap-1.5">
                                        <span id="output-indicator"
                                            class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse hidden shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                                        <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i> ä¼˜åŒ–ç»“æœ
                                    </span>
                                    <div class="flex items-center gap-3">
                                        <span id="output-char-count"
                                            class="text-xs font-mono text-slate-500 bg-slate-100/80 px-2.5 py-1 rounded-md font-semibold">0 å­—ç¬¦</span>
                                        <button id="btn-copy" disabled
                                            class="group text-xs flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-100 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                                            <i data-lucide="copy"
                                                class="w-3.5 h-3.5 group-hover:scale-110 transition-transform"></i>
                                            <span id="copy-text">å¤åˆ¶</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="px-5 pb-5 relative z-10 h-[28rem] min-h-[28rem] max-h-[28rem]">
                <textarea id="output-prompt" readonly
                    class="w-full h-full box-border p-4 resize-none bg-white border-2 border-slate-200/80 rounded-xl text-slate-800 font-mono text-sm leading-relaxed outline-none focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-400 transition-all shadow-sm hidden"></textarea>

                                    <div id="output-placeholder"
                                        class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none p-8 text-center">
                                        <div
                                            class="w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center mb-4 shadow-inner">
                                            <i data-lucide="sparkles" class="w-10 h-10 opacity-30 text-slate-400"></i>
                                        </div>
                                        <p class="text-sm font-medium text-slate-400 mb-1">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä¼˜åŒ–</p>
                                        <p class="text-xs text-slate-300">è¾“å…¥å†…å®¹åç‚¹å‡»"å¼€å§‹ä¼˜åŒ–"æŒ‰é’®</p>
                                    </div>
                                </div>
                                <!-- Subtle decorative gradient behind output -->
                                <div
                                    class="absolute bottom-0 right-0 w-64 h-64 bg-emerald-500/5 rounded-full filter blur-3xl pointer-events-none">
                                </div>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div
                            class="p-6 bg-gradient-to-r from-white to-slate-50/50 border-t border-slate-100 flex justify-center relative z-20">
                            <button id="btn-optimize" disabled
                                class="group relative inline-flex items-center justify-center gap-3 px-12 py-4 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white rounded-xl font-bold text-sm shadow-xl shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:-translate-y-0.5 active:translate-y-0 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0 overflow-hidden">
                                <div
                                    class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out">
                                </div>
                                <i id="icon-optimize" data-lucide="sparkles" class="w-5 h-5 relative z-10"></i>
                                <i id="icon-loading" data-lucide="loader-2"
                                    class="w-5 h-5 animate-spin hidden relative z-10"></i>
                                <span id="btn-text" class="relative z-10">å¼€å§‹ä¼˜åŒ–</span>
                                <i id="icon-arrow" data-lucide="arrow-right"
                                    class="w-4 h-4 group-hover:translate-x-1 transition-transform relative z-10"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Instruction Optimization Reasoning Card -->
                    <div id="reasoning-card"
                        class="hidden glass-panel rounded-2xl shadow-xl shadow-indigo-100/50 overflow-hidden mt-6 animate-fade-in-up">
                        <div class="p-5 border-b border-slate-100 bg-white/40 flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-lg bg-amber-50 border border-amber-100 flex items-center justify-center text-amber-600">
                                <i data-lucide="lightbulb" class="w-4 h-4"></i>
                            </div>
                            <h3 class="font-bold text-slate-800 text-sm">ä¼˜åŒ–æ€è·¯</h3>
                            <button id="btn-copy-reasoning"
                                class="ml-auto text-xs flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-100">
                                <i data-lucide="copy" class="w-3.5 h-3.5"></i>
                                <span>å¤åˆ¶</span>
                            </button>
                        </div>
                        <div class="p-6 bg-white/30 text-sm text-slate-600 leading-relaxed whitespace-pre-wrap"
                            id="reasoning-content"></div>
                    </div>
                </div>

                <!-- Sidebar (Right) -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Usage Stats Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">ä½¿ç”¨äººæ•°</h3>
                                <p class="text-xs text-slate-500">ç»Ÿè®¡æ•°æ®</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-blue-700 uppercase tracking-wider">æ€»ä½¿ç”¨æ¬¡æ•°</span>
                                </div>
                                <p class="usage-count-display text-2xl font-bold text-slate-800 mb-2">0</p>

                            </div>
                        </div>
                    </div>

                    <!-- Current Preset Info Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-purple-50 flex items-center justify-center text-purple-600">
                                <i data-lucide="bookmark" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">å½“å‰é¢„è®¾</h3>
                                <p class="text-xs text-slate-500">ä¼˜åŒ–ç­–ç•¥</p>
                            </div>
                        </div>
                        <div id="current-preset-display" class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-indigo-700 uppercase tracking-wider">é¢„è®¾åç§°</span>
                                    <button id="btn-open-settings-from-sidebar"
                                        class="text-xs text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1">
                                        <i data-lucide="settings" class="w-3 h-3"></i>
                                        ç®¡ç†
                                    </button>
                                </div>
                                <p id="preset-name-display" class="text-sm font-semibold text-slate-800 mb-2">æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶</p>
                                <p id="preset-preview" class="text-xs text-slate-600 line-clamp-3 leading-relaxed">
                                    ä½ æ˜¯ä¸€ä¸ªæŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶ã€‚è¯·æ·±åº¦åˆ†æç”¨æˆ·çš„åŸå§‹æŒ‡ä»¤ï¼Œè¯†åˆ«å…¶ä¸­çš„æ¨¡ç³Šã€æ­§ä¹‰æˆ–é€»è¾‘æ¼æ´ã€‚è¯·é‡å†™è¯¥æŒ‡ä»¤ï¼Œä½¿å…¶å…·å¤‡æ˜ç¡®çš„ç›®æ ‡å¯¼å‘ã€æ¸…æ™°çš„æ­¥éª¤æˆ–çº¦æŸæ¡ä»¶ã€å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å’Œä¸“ä¸šçš„è¡¨è¾¾æ–¹å¼ã€‚
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Tips Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center text-amber-600">
                                <i data-lucide="lightbulb" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 id="tips-title" class="font-bold text-slate-800 text-sm">ä¼˜åŒ–æŠ€å·§</h3>
                                <p id="tips-subtitle" class="text-xs text-slate-500">ä½¿ç”¨å»ºè®®</p>
                            </div>
                        </div>
                        <div id="tips-content" class="space-y-3 text-xs text-slate-600">
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>æ˜ç¡®çš„ç›®æ ‡å¯¼å‘</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>æ¸…æ™°çš„æ­¥éª¤æˆ–çº¦æŸæ¡ä»¶</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>ä¸“ä¸šçš„è¡¨è¾¾æ–¹å¼</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Reverse Module -->
            <div id="view-image-reverse" class="hidden grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Main Workspace (Left) -->
                <div class="lg:col-span-8 space-y-6">
                    <div
                        class="glass-panel rounded-2xl shadow-xl shadow-purple-100/50 overflow-hidden flex flex-col min-h-[600px] h-full">
                        <!-- Header Strip -->
                        <div class="h-1.5 w-full bg-gradient-to-r from-purple-500 via-pink-500 to-rose-500"></div>

                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/40">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-purple-50 border border-purple-100 flex items-center justify-center text-purple-600 shadow-sm">
                                    <i data-lucide="image" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="font-bold text-slate-800 text-lg tracking-tight">å›¾åƒåæ¨å·¥ä½œå°</h2>
                                    <p class="text-xs text-slate-500 font-medium">Reverse engineer prompts from images
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex-1 grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200/60">
                            <!-- Image Upload Section -->
                            <div class="flex flex-col bg-white/30 p-1">
                                <div
                                    class="px-5 py-3 flex justify-between items-center bg-gradient-to-r from-slate-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
                                        <i data-lucide="upload" class="w-3.5 h-3.5 text-purple-500"></i> ä¸Šä¼ å›¾ç‰‡
                                    </span>
                                    <button id="btn-clear-image"
                                        class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all hidden"
                                        title="æ¸…é™¤å›¾ç‰‡">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                                <div class="flex-1 px-5 pb-5 relative">
                                    <input type="file" id="input-image" accept="image/*" class="hidden">
                                    <div id="image-dropzone"
                                        class="w-full h-full border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-purple-400 hover:bg-purple-50/30 transition-all group">
                                        <div class="text-center p-8">
                                            <div
                                                class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-100 to-pink-100 flex items-center justify-center group-hover:scale-110 transition-transform">
                                                <i data-lucide="image-plus" class="w-8 h-8 text-purple-600"></i>
                                            </div>
                                            <p class="text-sm font-semibold text-slate-700 mb-1">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
                                            <p class="text-xs text-slate-400">æ”¯æŒ JPG, PNG, WebP æ ¼å¼</p>
                                        </div>
                                    </div>
                                    <div id="image-preview-container" class="w-full h-full hidden">
                                        <img id="image-preview" class="w-full h-full object-contain rounded-xl"
                                            alt="Preview">
                                    </div>
                                </div>
                            </div>

                            <!-- Output Section -->
                            <div class="flex flex-col bg-slate-50/50 p-1 relative overflow-hidden">
                                <div
                                    class="px-5 py-3 flex justify-between items-center z-10 bg-gradient-to-r from-emerald-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-emerald-600 uppercase tracking-wider flex items-center gap-1.5">
                                        <span id="output-indicator-image"
                                            class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse hidden shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                                        <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i> åæ¨ç»“æœ
                                    </span>
                                    <button id="btn-copy-image" disabled
                                        class="group text-xs flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-100 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                                        <i data-lucide="copy"
                                            class="w-3.5 h-3.5 group-hover:scale-110 transition-transform"></i>
                                        <span id="copy-text-image">å¤åˆ¶</span>
                                    </button>
                                </div>
                                <div class="flex-1 px-5 pb-5 relative z-10">
                                    <textarea id="output-image-prompt" readonly
                                        class="w-full h-full p-4 resize-none bg-white border-2 border-slate-200/80 rounded-xl text-slate-800 font-mono text-sm leading-relaxed outline-none focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-400 transition-all shadow-sm hidden"></textarea>

                                    <div id="output-placeholder-image"
                                        class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none p-8 text-center">
                                        <div
                                            class="w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center mb-4 shadow-inner">
                                            <i data-lucide="sparkles" class="w-10 h-10 opacity-30 text-slate-400"></i>
                                        </div>
                                        <p class="text-sm font-medium text-slate-400 mb-1">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…åæ¨</p>
                                        <p class="text-xs text-slate-300">ä¸Šä¼ å›¾ç‰‡åç‚¹å‡»"åæ¨æç¤ºè¯"æŒ‰é’®</p>
                                    </div>
                                </div>
                                <div
                                    class="absolute bottom-0 right-0 w-64 h-64 bg-purple-500/5 rounded-full filter blur-3xl pointer-events-none">
                                </div>
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div
                            class="p-6 bg-gradient-to-r from-white to-slate-50/50 border-t border-slate-100 flex justify-center relative z-20">
                            <button id="btn-reverse" disabled
                                class="group relative inline-flex items-center justify-center gap-3 px-12 py-4 bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 text-white rounded-xl font-bold text-sm shadow-xl shadow-purple-500/30 hover:shadow-purple-500/50 hover:-translate-y-0.5 active:translate-y-0 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0 overflow-hidden">
                                <div
                                    class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out">
                                </div>
                                <i id="icon-reverse" data-lucide="scan" class="w-5 h-5 relative z-10"></i>
                                <i id="icon-loading-image" data-lucide="loader-2"
                                    class="w-5 h-5 animate-spin hidden relative z-10"></i>
                                <span id="btn-text-image" class="relative z-10">åæ¨æç¤ºè¯</span>
                                <i id="icon-arrow-image" data-lucide="arrow-right"
                                    class="w-4 h-4 group-hover:translate-x-1 transition-transform relative z-10"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar (Right) - Same as other modules -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Usage Stats Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">ä½¿ç”¨äººæ•°</h3>
                                <p class="text-xs text-slate-500">ç»Ÿè®¡æ•°æ®</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-blue-700 uppercase tracking-wider">æ€»ä½¿ç”¨æ¬¡æ•°</span>
                                </div>
                                <p class="usage-count-display text-2xl font-bold text-slate-800 mb-2">0</p>

                            </div>
                        </div>
                    </div>

                    <!-- Current Preset Info Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-purple-50 flex items-center justify-center text-purple-600">
                                <i data-lucide="bookmark" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">å½“å‰é¢„è®¾</h3>
                                <p class="text-xs text-slate-500">ä¼˜åŒ–ç­–ç•¥</p>
                            </div>
                        </div>
                        <div id="current-preset-display-image" class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border border-purple-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-purple-700 uppercase tracking-wider">é¢„è®¾åç§°</span>
                                    <button id="btn-open-settings-from-sidebar-image"
                                        class="text-xs text-purple-600 hover:text-purple-700 font-medium flex items-center gap-1">
                                        <i data-lucide="settings" class="w-3 h-3"></i>
                                        ç®¡ç†
                                    </button>
                                </div>
                                <p id="preset-name-display-image" class="text-sm font-semibold text-slate-800 mb-2">è¯¦ç»†æè¿°
                                </p>
                                <p id="preset-preview-image"
                                    class="text-xs text-slate-600 line-clamp-3 leading-relaxed">ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒåˆ†æä¸“å®¶ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tips Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center text-amber-600">
                                <i data-lucide="lightbulb" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">ä¼˜åŒ–æŠ€å·§</h3>
                                <p class="text-xs text-slate-500">ä½¿ç”¨å»ºè®®</p>
                            </div>
                        </div>
                        <div id="tips-content-image" class="space-y-3 text-xs text-slate-600">
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>ä¸Šä¼ æ¸…æ™°ã€é«˜è´¨é‡çš„å›¾ç‰‡ä»¥è·å¾—æ›´å¥½çš„æè¿°</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>é€‰æ‹©åˆé€‚é¢„è®¾ä»¥åŒ¹é…æè¿°é£æ ¼</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Instruction Reverse Module -->
            <div id="view-instruction-reverse" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Main Workspace (Left) -->
                <div class="lg:col-span-8 space-y-6">
                    <div
                        class="glass-panel rounded-2xl shadow-xl shadow-blue-100/50 overflow-hidden flex flex-col min-h-[600px] h-full">
                        <!-- Header Strip -->
                        <div class="h-1.5 w-full bg-gradient-to-r from-blue-500 via-cyan-500 to-teal-500"></div>

                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/40">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-blue-50 border border-blue-100 flex items-center justify-center text-blue-600 shadow-sm">
                                    <i data-lucide="layers" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <h2 class="font-bold text-slate-800 text-lg tracking-tight">æŒ‡ä»¤åæ¨å·¥ä½œå°</h2>
                                    <p class="text-xs text-slate-500 font-medium">Upload images and generate
                                        instructions</p>
                                </div>
                            </div>
                        </div>

                        <div
                            class="flex-1 grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200/60">
                            <!-- Image 1 Upload Section -->
                            <div class="flex flex-col bg-white/30 p-1">
                                <div
                                    class="px-5 py-3 flex justify-between items-center bg-gradient-to-r from-slate-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
                                        <i data-lucide="upload" class="w-3.5 h-3.5 text-blue-500"></i> å›¾ç‰‡ 1
                                    </span>
                                    <button id="btn-clear-image1"
                                        class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all hidden"
                                        title="æ¸…é™¤å›¾ç‰‡">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                                <div class="flex-1 px-5 pb-5 relative">
                                    <input type="file" id="input-image1" accept="image/*" class="hidden">
                                    <div id="image-dropzone1"
                                        class="w-full h-full border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/30 transition-all group">
                                        <div class="text-center p-6">
                                            <div
                                                class="w-14 h-14 mx-auto mb-3 rounded-2xl bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center group-hover:scale-110 transition-transform">
                                                <i data-lucide="image-plus" class="w-7 h-7 text-blue-600"></i>
                                            </div>
                                            <p class="text-sm font-semibold text-slate-700 mb-1">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡ 1</p>
                                            <p class="text-xs text-slate-400">æ”¯æŒ JPG, PNG, WebP æ ¼å¼</p>
                                        </div>
                                    </div>
                                    <div id="image-preview-container1" class="w-full h-full hidden">
                                        <img id="image-preview1" class="w-full h-full object-contain rounded-xl"
                                            alt="Preview 1">
                                    </div>
                                </div>
                            </div>

                            <!-- Image 2 Upload Section -->
                            <div class="flex flex-col bg-white/30 p-1">
                                <div
                                    class="px-5 py-3 flex justify-between items-center bg-gradient-to-r from-slate-50/50 to-transparent">
                                    <span
                                        class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
                                        <i data-lucide="upload" class="w-3.5 h-3.5 text-teal-500"></i> å›¾ç‰‡ 2
                                    </span>
                                    <button id="btn-clear-image2"
                                        class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all hidden"
                                        title="æ¸…é™¤å›¾ç‰‡">
                                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                    </button>
                                </div>
                                <div class="flex-1 px-5 pb-5 relative">
                                    <input type="file" id="input-image2" accept="image/*" class="hidden">
                                    <div id="image-dropzone2"
                                        class="w-full h-full border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-teal-400 hover:bg-teal-50/30 transition-all group">
                                        <div class="text-center p-6">
                                            <div
                                                class="w-14 h-14 mx-auto mb-3 rounded-2xl bg-gradient-to-br from-teal-100 to-cyan-100 flex items-center justify-center group-hover:scale-110 transition-transform">
                                                <i data-lucide="image-plus" class="w-7 h-7 text-teal-600"></i>
                                            </div>
                                            <p class="text-sm font-semibold text-slate-700 mb-1">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡ 2</p>
                                            <p class="text-xs text-slate-400">æ”¯æŒ JPG, PNG, WebP æ ¼å¼</p>
                                        </div>
                                    </div>
                                    <div id="image-preview-container2" class="w-full h-full hidden">
                                        <img id="image-preview2" class="w-full h-full object-contain rounded-xl"
                                            alt="Preview 2">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Input Section (only for instruction-reverse) -->
                        <div class="flex flex-col bg-white/30 p-1 border-t border-slate-200/60">
                            <div
                                class="px-5 py-3 flex justify-between items-center bg-gradient-to-r from-slate-50/50 to-transparent">
                                <span
                                    class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5">
                                    <i data-lucide="message-square" class="w-3.5 h-3.5 text-blue-500"></i> ç”¨æˆ·è¾“å…¥
                                </span>
                                <span id="instruction-reverse-char-count"
                                    class="text-xs font-mono text-slate-500 bg-slate-100/80 px-2.5 py-1 rounded-md font-semibold">0
                                    å­—ç¬¦</span>
                            </div>
                            <div class="px-5 pb-5">
                                <textarea id="input-instruction-reverse-text" placeholder="æè¿°ä½ å¸Œæœ›æ ¹æ®ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆçš„æŒ‡ä»¤æˆ–ç›®æ ‡..."
                                    class="w-full h-28 p-4 resize-none bg-white border-2 border-slate-200 rounded-xl text-slate-700 font-mono text-sm leading-relaxed placeholder:text-slate-400 outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-400 transition-all shadow-sm"></textarea>
                            </div>
                        </div>

                        <!-- Output Section -->
                        <div
                            class="flex flex-col bg-slate-50/50 p-1 relative overflow-hidden border-t border-slate-200/60">
                            <div
                                class="px-5 py-3 flex justify-between items-center z-10 bg-gradient-to-r from-emerald-50/50 to-transparent">
                                <span
                                    class="text-xs font-bold text-emerald-600 uppercase tracking-wider flex items-center gap-1.5">
                                    <span id="output-indicator-instruction-reverse"
                                        class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse hidden shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                                    <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i> æŒ‡ä»¤è¾“å‡º
                                </span>
                                <button id="btn-copy-instruction-reverse" disabled
                                    class="group text-xs flex items-center gap-1.5 px-3 py-1.5 rounded-lg transition-all text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 border border-transparent hover:border-emerald-100 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                                    <i data-lucide="copy"
                                        class="w-3.5 h-3.5 group-hover:scale-110 transition-transform"></i>
                                    <span id="copy-text-instruction-reverse">å¤åˆ¶</span>
                                </button>
                            </div>
                            <div class="flex-1 px-5 pb-5 relative z-10 min-h-[200px]">
                                <textarea id="output-instruction-reverse" readonly
                                    class="w-full h-full p-4 resize-none bg-white border-2 border-slate-200/80 rounded-xl text-slate-800 font-mono text-sm leading-relaxed outline-none focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-400 transition-all shadow-sm hidden"></textarea>

                                <div id="output-placeholder-instruction-reverse"
                                    class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none p-8 text-center">
                                    <div
                                        class="w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center mb-4 shadow-inner">
                                        <i data-lucide="layers" class="w-10 h-10 opacity-30 text-slate-400"></i>
                                    </div>
                                    <p class="text-sm font-medium text-slate-400 mb-1">å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä¼˜åŒ–</p>
                                    <p class="text-xs text-slate-300">ä¸Šä¼ ä¸¤å¼ å›¾ç‰‡å¹¶å¡«å†™æ–‡æœ¬åç‚¹å‡»"å¼€å§‹ä¼˜åŒ–"æŒ‰é’®</p>
                                </div>
                            </div>
                            <div
                                class="absolute bottom-0 right-0 w-64 h-64 bg-blue-500/5 rounded-full filter blur-3xl pointer-events-none">
                            </div>
                        </div>

                        <!-- Action Bar -->
                        <div
                            class="p-6 bg-gradient-to-r from-white to-slate-50/50 border-t border-slate-100 flex justify-center relative z-20">
                            <button id="btn-optimize-instruction-reverse" disabled
                                class="group relative inline-flex items-center justify-center gap-3 px-12 py-4 bg-gradient-to-r from-blue-600 via-cyan-600 to-teal-600 text-white rounded-xl font-bold text-sm shadow-xl shadow-blue-500/30 hover:shadow-blue-500/50 hover:-translate-y-0.5 active:translate-y-0 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-0 overflow-hidden">
                                <div
                                    class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out">
                                </div>
                                <i id="icon-optimize-instruction-reverse" data-lucide="sparkles"
                                    class="w-5 h-5 relative z-10"></i>
                                <i id="icon-loading-instruction-reverse" data-lucide="loader-2"
                                    class="w-5 h-5 animate-spin hidden relative z-10"></i>
                                <span id="btn-text-instruction-reverse" class="relative z-10">å¼€å§‹ä¼˜åŒ–</span>
                                <i id="icon-arrow-instruction-reverse" data-lucide="arrow-right"
                                    class="w-4 h-4 group-hover:translate-x-1 transition-transform relative z-10"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar (Right) -->
                <div class="lg:col-span-4 space-y-6">
                    <!-- Usage Stats Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">ä½¿ç”¨äººæ•°</h3>
                                <p class="text-xs text-slate-500">ç»Ÿè®¡æ•°æ®</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-blue-700 uppercase tracking-wider">æ€»ä½¿ç”¨æ¬¡æ•°</span>
                                </div>
                                <p class="usage-count-display text-2xl font-bold text-slate-800 mb-2">0</p>

                            </div>
                        </div>
                    </div>

                    <!-- Current Preset Info Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600">
                                <i data-lucide="bookmark" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">å½“å‰é¢„è®¾</h3>
                                <p class="text-xs text-slate-500">ä¼˜åŒ–ç­–ç•¥</p>
                            </div>
                        </div>
                        <div id="current-preset-display-instruction-reverse" class="space-y-3">
                            <div
                                class="p-4 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs font-bold text-blue-700 uppercase tracking-wider">é¢„è®¾åç§°</span>
                                    <button id="btn-open-settings-from-sidebar-instruction-reverse"
                                        class="text-xs text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
                                        <i data-lucide="settings" class="w-3 h-3"></i>
                                        ç®¡ç†
                                    </button>
                                </div>
                                <p id="preset-name-display-instruction-reverse"
                                    class="text-sm font-semibold text-slate-800 mb-2">è¯¦ç»†æè¿°
                                </p>
                                <p id="preset-preview-instruction-reverse"
                                    class="text-xs text-slate-600 line-clamp-3 leading-relaxed">
                                    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒå¯¹æ¯”åˆ†æä¸“å®¶ï¼Œèƒ½å¤Ÿæ ¹æ®ä¸¤å¼ å›¾ç‰‡ç”Ÿæˆè¯¦ç»†çš„æŒ‡ä»¤æè¿°ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tips Card -->
                    <div class="glass-panel rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center text-amber-600">
                                <i data-lucide="lightbulb" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-800 text-sm">ä¼˜åŒ–æŠ€å·§</h3>
                                <p class="text-xs text-slate-500">ä½¿ç”¨å»ºè®®</p>
                            </div>
                        </div>
                        <div id="tips-content-instruction-reverse" class="space-y-3 text-xs text-slate-600">
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>ä¸Šä¼ ä¸¤å¼ æ¸…æ™°å›¾ç‰‡ï¼Œå¹¶å¡«å†™æ–‡æœ¬ç›®æ ‡æˆ–çº¦æŸ</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                                <p>åœ¨è®¾ç½®ä¸­é€‰æ‹©æˆ–è‡ªå®šä¹‰åˆé€‚çš„é¢„è®¾</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 z-[120] hidden" role="dialog" aria-modal="true">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>

        <!-- Modal Panel -->
        <div class="absolute inset-0 z-10 flex items-center justify-center p-4">
            <div
                class="relative w-full max-w-sm bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden transform transition-all scale-100">
                <!-- Header -->
                <div class="px-6 py-5 bg-slate-50 border-b border-slate-100 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                    </div>
                    <div>
                        <h3 class="text-base font-bold text-slate-800">ç¡®è®¤åˆ é™¤</h3>
                        <p class="text-xs text-slate-500">æ­¤æ“ä½œä¸å¯æ¢å¤</p>
                    </div>
                </div>

                <!-- Content -->
                <div class="p-6">
                    <p id="delete-modal-message" class="text-sm text-slate-600 leading-relaxed"></p>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-slate-50/50 flex gap-3">
                    <button id="cancel-delete-btn"
                        class="flex-1 px-4 py-2.5 bg-white text-slate-700 text-sm font-semibold rounded-xl border border-slate-200 hover:bg-slate-50 hover:border-slate-300 transition-all shadow-sm">
                        å–æ¶ˆ
                    </button>
                    <button id="confirm-delete-btn"
                        class="flex-1 px-4 py-2.5 bg-red-600 text-white text-sm font-semibold rounded-xl hover:bg-red-700 transition-all shadow-md flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        ç¡®è®¤åˆ é™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div
                class="relative w-full max-w-4xl h-[90vh] bg-white rounded-3xl overflow-hidden flex flex-col modal-content">
                <!-- Modal Header -->
                <div
                    class="px-8 py-6 border-b border-slate-100 flex items-center justify-between bg-slate-50/50 flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 rounded-2xl bg-indigo-600 flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                            <i data-lucide="settings" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-900 tracking-tight">å…¨å±€é…ç½®</h2>
                            <p class="text-xs text-slate-500 font-medium">API Keys and Advanced Presets</p>
                        </div>
                    </div>
                    <button id="btn-close-settings"
                        class="p-2.5 rounded-xl hover:bg-slate-200/50 text-slate-400 hover:text-slate-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto p-8 pb-24">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                        <!-- Left Sidebar: Navigation -->
                        <div class="md:col-span-1 space-y-2">
                            <button id="modal-tab-api"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-50 text-indigo-700 font-bold transition-all border border-indigo-100 shadow-sm">
                                <i data-lucide="key" class="w-5 h-5"></i>
                                API é…ç½®
                            </button>
                            <button id="modal-tab-presets"
                                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition-all border border-transparent hover:border-slate-200">
                                <i data-lucide="bookmark" class="w-5 h-5"></i>
                                é¢„è®¾ç®¡ç†
                            </button>
                        </div>

                        <!-- Content Area -->
                        <div class="md:col-span-3">
                            <!-- API Settings Panel -->
                            <div id="modal-panel-api" class="space-y-6">
                                <!-- LLM Configuration -->
                                <div
                                    class="bg-gradient-to-br from-indigo-50/50 to-blue-50/30 rounded-2xl p-6 border border-indigo-100/50">
                                    <div class="flex items-center gap-3 mb-5">
                                        <div
                                            class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white shadow-lg">
                                            <i data-lucide="brain" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-base font-bold text-slate-900">æ–‡æœ¬å¤§æ¨¡å‹ (LLM)</h3>
                                            <p class="text-xs text-slate-500">é…ç½®ç”¨äºæ–‡æœ¬ç”Ÿæˆå’Œä¼˜åŒ–çš„ AI æ¨¡å‹</p>
                                        </div>
                                    </div>

                                    <div class="space-y-4">
                                        <div class="space-y-2">
                                            <label class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                                                <i data-lucide="key" class="w-4 h-4 text-indigo-600"></i>
                                                API å¯†é’¥
                                            </label>
                                            <div class="relative">
                                                <input id="input-api-key" type="password" placeholder="sk-..."
                                                    class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all shadow-sm">
                                                <button id="btn-toggle-key"
                                                    class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-slate-400 hover:text-indigo-600 transition-colors">
                                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>



                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="space-y-2">
                                                <label
                                                    class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                                                    <i data-lucide="globe" class="w-4 h-4 text-indigo-600"></i>
                                                    æ¥å£åœ°å€
                                                </label>
                                                <select id="select-base-url"
                                                    class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm outline-none cursor-pointer focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all shadow-sm">
                                                    <option
                                                        value="https://generativelanguage.googleapis.com/v1beta/openai">
                                                        Google Gemini</option>
                                                    <option value="https://api.siliconflow.cn/v1">SiliconFlow</option>
                                                    <option value="https://ark.cn-beijing.volces.com/api/v3">è±†åŒ… (Doubao)
                                                        - å…¬ç½‘</option>
                                                    <option value="https://ark-cn-beijing.bytedance.net/api/v3">è±†åŒ…
                                                        (Doubao) - å†…ç½‘</option>
                                                    <option value="https://ai.t8star.cn/v1">T8Star AI</option>
                                                    <option value="https://api.deepseek.com">Deepseek</option>
                                                    <option value="https://api.openai.com/v1">OpenAI</option>
                                                </select>
                                            </div>
                                            <div class="space-y-2">
                                                <label
                                                    class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                                                    <i data-lucide="cpu" class="w-4 h-4 text-indigo-600"></i>
                                                    æ¨¡å‹åç§°
                                                </label>
                                                <select id="select-model"
                                                    class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm outline-none cursor-pointer focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all shadow-sm">
                                                    <option value="ep-20251030180013-p4bww">Doubao-Pro</option>
                                                    <option value="deepseek-chat">deepseek-chat</option>
                                                    <option value="gpt-4o">GPT-4o (æ”¯æŒè§†è§‰)</option>
                                                    <option value="gpt-4-turbo">GPT-4 Turbo (æ”¯æŒè§†è§‰)</option>
                                                    <option value="gpt-4-vision-preview">GPT-4 Vision Preview</option>
                                                    <option value="gpt-4o-mini">GPT-4o Mini (æ”¯æŒè§†è§‰)</option>
                                                </select>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <!-- CV Configuration -->
                                <div
                                    class="bg-gradient-to-br from-purple-50/50 to-pink-50/30 rounded-2xl p-6 border border-purple-100/50">
                                    <div class="flex items-center gap-3 mb-5">
                                        <div
                                            class="w-10 h-10 rounded-xl bg-purple-600 flex items-center justify-center text-white shadow-lg">
                                            <i data-lucide="eye" class="w-5 h-5"></i>
                                        </div>
                                        <div>
                                            <h3 class="text-base font-bold text-slate-900">è§†è§‰æ¨¡å‹ (CV)</h3>
                                            <p class="text-xs text-slate-500">é…ç½®ç”¨äºå›¾åƒåˆ†æçš„ AI æ¨¡å‹å¯†é’¥</p>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div class="space-y-2">
                                            <label class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                                                <i data-lucide="key" class="w-4 h-4 text-purple-600"></i>
                                                Access Key (AK)
                                            </label>
                                            <input id="input-cv-ak" type="text" placeholder="Access Key"
                                                class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 outline-none transition-all shadow-sm">
                                        </div>
                                        <div class="space-y-2">
                                            <label class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                                                <i data-lucide="lock" class="w-4 h-4 text-purple-600"></i>
                                                Secret Key (SK)
                                            </label>
                                            <input id="input-cv-sk" type="password" placeholder="Secret Key"
                                                class="w-full px-4 py-3 bg-white border-2 border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 outline-none transition-all shadow-sm">
                                        </div>
                                    </div>

                                </div>

                                <!-- Tips -->
                                <div class="bg-blue-50/50 border border-blue-200/50 rounded-xl p-4">
                                    <div class="flex items-start gap-3">
                                        <i data-lucide="info" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"></i>
                                        <div class="text-xs text-slate-600 leading-relaxed">
                                            <p class="font-semibold text-slate-700 mb-1">ğŸ’¡ æ¨èé…ç½®ï¼š</p>
                                            <p><b>Gemini 1.5 Flash</b> æ¯åˆ†é’Ÿæä¾› 15 æ¬¡å…è´¹è¯·æ±‚ï¼Œéå¸¸é€‚åˆæ–°æ‰‹ã€‚</p>
                                            <p class="mt-1"><b>SiliconFlow</b> å¸¸ç”¨ Qwen2-VL æ¨¡å‹ä¹Ÿæœ‰ä¸é”™çš„å…è´¹é¢åº¦ã€‚</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Presets Management Panel (Hidden by default) -->
                            <div id="modal-panel-presets" class="hidden space-y-6">
                                <!-- Preset Type Tabs -->
                                <div
                                    class="flex items-center gap-2 p-1.5 bg-slate-100 rounded-2xl border border-slate-200/50 w-fit">
                                    <button id="btn-toggle-preset-prompt-helper"
                                        class="px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all">
                                        <i data-lucide="sparkles" class="w-4 h-4 inline-block mr-1.5"></i>
                                        æç¤ºè¯å¸®å†™
                                    </button>
                                    <button id="btn-toggle-preset-instruction"
                                        class="px-5 py-2 rounded-xl text-sm font-bold bg-white shadow-sm text-indigo-600 border border-slate-100 transition-all">
                                        <i data-lucide="command" class="w-4 h-4 inline-block mr-1.5"></i>
                                        æŒ‡ä»¤ä¼˜åŒ–
                                    </button>
                                    <button id="btn-toggle-preset-image-reverse"
                                        class="px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all">
                                        <i data-lucide="image" class="w-4 h-4 inline-block mr-1.5"></i>
                                        å›¾åƒåæ¨
                                    </button>
                                    <button id="btn-toggle-preset-instruction-reverse"
                                        class="px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all">
                                        <i data-lucide="arrow-left-right" class="w-4 h-4 inline-block mr-1.5"></i>
                                        æŒ‡ä»¤åæ¨
                                    </button>
                                </div>

                                <!-- Presets List with Inline Editing -->
                                <div class="space-y-3">
                                    <!-- Toolbar: New / Export / Import in one line -->
                                    <div class="flex items-center gap-2">
                                        <button id="btn-new-preset"
                                            class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-xs font-medium hover:bg-indigo-700 transition-all flex items-center gap-1.5">
                                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                                            æ–°å»ºé¢„è®¾
                                        </button>
                                        <button id="btn-export-presets"
                                            class="px-3 py-2 bg-slate-100 text-slate-700 rounded-lg text-xs font-medium border border-slate-200 hover:bg-slate-200 transition-all flex items-center gap-1.5">
                                            <i data-lucide="download" class="w-3.5 h-3.5"></i>
                                            å¯¼å‡ºé¢„è®¾
                                        </button>
                                        <button id="btn-import-presets"
                                            class="px-3 py-2 bg-slate-100 text-slate-700 rounded-lg text-xs font-medium border border-slate-200 hover:bg-slate-200 transition-all flex items-center gap-1.5">
                                            <i data-lucide="upload" class="w-3.5 h-3.5"></i>
                                            å¯¼å…¥é¢„è®¾
                                        </button>
                                        <input id="input-import-presets" type="file" accept="application/json"
                                            class="hidden" />
                                    </div>
                                    <!-- Presets List (Card View) -->
                                    <div id="presets-list-container"
                                        class="space-y-3 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer (Fixed at Bottom) -->
                    <div
                        class="absolute bottom-0 left-0 right-0 p-6 border-t border-slate-100 flex justify-end items-center bg-white/95 backdrop-blur-sm z-10">
                        <button id="btn-save-all-config"
                            class="px-8 py-2.5 bg-indigo-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            ä¿å­˜å…¨éƒ¨é…ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </main>

        <!-- Toast Notification -->
        <div id="toast"
            class="fixed bottom-8 right-8 z-50 transition-all duration-300 transform translate-y-24 opacity-0 pointer-events-none">
            <div id="toast-content"
                class="flex items-center gap-3 px-6 py-4 rounded-xl shadow-2xl border bg-white/90 backdrop-blur-md">
                <i id="toast-icon" data-lucide="alert-circle" class="w-6 h-6"></i>
                <span id="toast-message" class="font-medium text-sm"></span>
            </div>
        </div>

        <script>
            const DEFAULT_CONFIG = {
                apiKey: '',
                baseURL: 'https://ark.cn-beijing.volces.com/api/v3',
                model: 'ep-20251030180013-p4bww',
                cvAK: '',
                cvSK: ''
            };

            const DEFAULT_INSTRUCTION_PRESETS = {
                'æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶': 'ä½ æ˜¯ä¸€ä¸ªæŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶ã€‚è¯·æ·±åº¦åˆ†æç”¨æˆ·çš„åŸå§‹æŒ‡ä»¤ï¼Œè¯†åˆ«å…¶ä¸­çš„æ¨¡ç³Šã€æ­§ä¹‰æˆ–é€»è¾‘æ¼æ´ã€‚è¯·åœ¨å›å¤ä¸­åŒ…å«ä½ çš„ä¼˜åŒ–æ€è·¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n\nã€ä¼˜åŒ–æ€è·¯ã€‘\nï¼ˆåœ¨è¿™é‡Œè¯¦ç»†æè¿°ä½ çš„ä¼˜åŒ–æ€è·¯ã€æ”¹è¿›å»ºè®®å’Œé‡‡å–çš„æ–¹æ¡ˆï¼‰\n\nã€ä¼˜åŒ–ç»“æœã€‘\nï¼ˆåœ¨è¿™é‡Œæä¾›é‡å†™åçš„æŒ‡ä»¤ï¼‰\n\nç¡®ä¿ä¼˜åŒ–åçš„æŒ‡ä»¤å…·å¤‡ï¼š\n1. æ˜ç¡®çš„ç›®æ ‡å¯¼å‘\n2. æ¸…æ™°çš„æ­¥éª¤æˆ–çº¦æŸæ¡ä»¶\n3. å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯\n4. ä¸“ä¸šçš„è¡¨è¾¾æ–¹å¼ã€‚',
                'BRRE ç»“æ„åŒ–': 'ä½ æ˜¯ä¸€ä¸ªæç¤ºè¯ä¸“å®¶ã€‚è¯·å°†ç”¨æˆ·è¾“å…¥æ”¹å†™ä¸º BRRE ç»“æ„ï¼š\n- Background (èƒŒæ™¯): è®¾å®šèƒŒæ™¯ä¿¡æ¯\n- Role (è§’è‰²): è®¾å®š AI æ‰®æ¼”çš„è§’è‰²\n- Request (ä»»åŠ¡): æ˜ç¡®å…·ä½“çš„ä»»åŠ¡\n- Expectations (æœŸæœ›): è®¾å®šè¾“å‡ºçš„æ ‡å‡†å’Œé™åˆ¶ã€‚',
                'CRISPE æ¡†æ¶': 'è¯·åº”ç”¨ CRISPE æ¡†æ¶ä¼˜åŒ–æ­¤æŒ‡ä»¤ï¼š\n- Capacity and Role (èƒ½åŠ›ä¸è§’è‰²): AI åº”å…·å¤‡çš„ä¸“ä¸šèƒ½åŠ›\n- Insight (æ´å¯Ÿ): ç›¸å…³çš„èƒŒæ™¯çŸ¥è¯†å’Œä¸Šä¸‹æ–‡\n- Statement (é™ˆè¿°): å…·ä½“çš„ä»»åŠ¡é™ˆè¿°\n- Personality (ä¸ªæ€§): å›å¤çš„è¯­æ°”å’Œé£æ ¼\n- Experiment (å®éªŒ): æä¾›çš„é€‰é¡¹æˆ–å°è¯•æ–¹å‘ã€‚'
            };

            const DEFAULT_IMAGE_REVERSE_PRESETS = {
                'è¯¦ç»†æè¿°': 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒåˆ†æä¸“å®¶ã€‚è¯·è¯¦ç»†æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹,åŒ…æ‹¬ä¸»è¦å¯¹è±¡ã€åœºæ™¯ã€é¢œè‰²ã€æ„å›¾ã€å…‰å½±ç­‰ç»†èŠ‚ã€‚ç”¨æ¸…æ™°ã€å‡†ç¡®çš„è¯­è¨€æè¿°,é€‚åˆä½œä¸ºAIç»˜å›¾çš„æç¤ºè¯ã€‚',
                'è‰ºæœ¯é£æ ¼åˆ†æ': 'ä½ æ˜¯ä¸€ä½è‰ºæœ¯è¯„è®ºå®¶ã€‚è¯·åˆ†æè¿™å¼ å›¾ç‰‡çš„è‰ºæœ¯é£æ ¼ã€ç»˜ç”»æŠ€æ³•ã€è‰²å½©è¿ç”¨ã€æ„å›¾æ–¹å¼å’Œæ•´ä½“è§†è§‰æ•ˆæœã€‚è¯†åˆ«å¯èƒ½çš„è‰ºæœ¯æµæ´¾æˆ–é£æ ¼ç‰¹å¾ã€‚',
                'åœºæ™¯è¯†åˆ«': 'ä½ æ˜¯ä¸€ä¸ªåœºæ™¯è¯†åˆ«ä¸“å®¶ã€‚è¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„åœºæ™¯ç±»å‹ã€ä¸»è¦å…ƒç´ ã€ç¯å¢ƒç‰¹å¾ã€æ°›å›´æ„Ÿå—å’Œå¯èƒ½çš„ç”¨é€”æˆ–ä¸»é¢˜ã€‚æä¾›ç»“æ„åŒ–çš„åœºæ™¯æè¿°ã€‚'
            };

            const DEFAULT_INSTRUCTION_REVERSE_PRESETS = {
                'è¯¦ç»†å¯¹æ¯”åˆ†æ': 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒå¯¹æ¯”åˆ†æä¸“å®¶ã€‚è¯·ä»”ç»†åˆ†æä¸¤å¼ å›¾ç‰‡ï¼Œè¯†åˆ«å®ƒä»¬çš„ç›¸ä¼¼ä¹‹å¤„å’Œå·®å¼‚ä¹‹å¤„ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„æŒ‡ä»¤æè¿°ï¼Œè¯´æ˜å¦‚ä½•ä»å›¾ç‰‡1è½¬æ¢åˆ°å›¾ç‰‡2ã€‚åŒ…æ‹¬éœ€è¦ä¿®æ”¹çš„å…ƒç´ ã€é£æ ¼å˜åŒ–ã€æŠ€æœ¯å‚æ•°ç­‰ã€‚',
                'æ“ä½œæ­¥éª¤ç”Ÿæˆ': 'ä½ æ˜¯ä¸€ä¸ªå›¾åƒå¤„ç†æŒ‡ä»¤ç”Ÿæˆä¸“å®¶ã€‚é€šè¿‡å¯¹æ¯”ä¸¤å¼ å›¾ç‰‡ï¼Œç”Ÿæˆæ¸…æ™°çš„æ“ä½œæ­¥éª¤æŒ‡ä»¤ï¼Œè¯´æ˜å¦‚ä½•é€šè¿‡å›¾åƒç¼–è¾‘ã€é£æ ¼è½¬æ¢æˆ–å…¶ä»–æŠ€æœ¯æ‰‹æ®µï¼Œå°†å›¾ç‰‡1è½¬æ¢ä¸ºå›¾ç‰‡2çš„æ•ˆæœã€‚',
                'å·®å¼‚è¯†åˆ«æŒ‡ä»¤': 'ä½ æ˜¯ä¸€ä¸ªå›¾åƒå·®å¼‚åˆ†æä¸“å®¶ã€‚è¯·è¯†åˆ«ä¸¤å¼ å›¾ç‰‡ä¹‹é—´çš„å…³é”®å·®å¼‚ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç»“æ„åŒ–çš„æŒ‡ä»¤ï¼Œæè¿°è¿™äº›å·®å¼‚çš„å…·ä½“å†…å®¹å’Œå®ç°æ–¹æ³•ã€‚'
            };

            const CONFIG_KEY = 'promptshift_config_v3';
            const PRESETS_KEY = 'promptshift_presets_v2';
            const INSTRUCTION_PRESETS_KEY = 'promptshift_instruction_presets';
            const IMAGE_REVERSE_PRESETS_KEY = 'promptshift_image_reverse_presets';
            const INSTRUCTION_REVERSE_PRESETS_KEY = 'promptshift_instruction_reverse_presets';
            const ACTIVE_PRESETS_KEY = 'promptshift_active_presets';
            const CURRENT_MODULE_KEY = 'promptshift_current_module';
            const PROMPT_HELPER_PRESETS_KEY = 'promptshift_prompt_helper_presets';
            const USAGE_COUNT_KEY = 'promptshift_usage_count';

            const DEFAULT_PROMPT_HELPER_PRESETS = {
                'ç»“æ„åŒ–å¸®å†™': {
                    step1: 'ä½ æ˜¯ä¸€åæç¤ºè¯å¸®å†™ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„åŸå§‹è¾“å…¥ï¼Œç”Ÿæˆç»“æ„åŒ–çš„é«˜è´¨é‡æç¤ºè¯ï¼ŒåŒ…å«ï¼šç›®æ ‡ã€ä¸Šä¸‹æ–‡ã€è§’è‰²/èƒ½åŠ›ã€è¾“å…¥çº¦æŸã€è¾“å‡ºæ ¼å¼ã€é£æ ¼ä¸é•¿åº¦ã€è¯„ä¼°æ ‡å‡†ã€‚åªè¾“å‡ºä¼˜åŒ–åçš„æç¤ºè¯ã€‚',
                    step2: 'ä½ æ˜¯ä¸€åæç¤ºè¯å¸®å†™ä¸“å®¶ã€‚è¯·ä»…è¾“å‡ºä½ çš„å¸®å†™æ€è·¯ï¼Œè§£é‡Šå¦‚ä½•æ‹†è§£ç”¨æˆ·éœ€æ±‚ã€å¦‚ä½•å¹³è¡¡å„è¦ç´ ä»¥åŠé‡‡å–çš„ç­–ç•¥ï¼Œä¸è¦é‡å¤æç¤ºè¯æ­£æ–‡ã€‚'
                },
                'ä»»åŠ¡æ‹†è§£': {
                    step1: 'è¯·å°†ç”¨æˆ·éœ€æ±‚æ‹†è§£ä¸ºå¯æ‰§è¡Œçš„æç¤ºè¯æ¨¡æ¿ï¼šç›®æ ‡ã€ä¸»è¦æ­¥éª¤ã€æ¯æ­¥çš„è¾“å…¥ä¸è¾“å‡ºã€æ³¨æ„äº‹é¡¹å’Œè¾¹ç•Œæ¡ä»¶ã€‚åªè¾“å‡ºæ¨¡æ¿ç»“æœã€‚',
                    step2: 'è¯·ä»…è¾“å‡ºä½ çš„æ€è·¯ï¼Œè§£é‡Šä¸ºä½•è¿™æ ·æ‹†è§£ã€å„æ­¥éª¤è®¾è®¡çš„è€ƒè™‘ä¸è¾¹ç•Œã€‚'
                },
                'é£æ ¼æ¨¡æ¿': {
                    step1: 'æ ¹æ®ç”¨æˆ·çš„ç”¨é€”ï¼ˆå¦‚ç§‘æ™®ã€å•†åŠ¡ã€æŠ€æœ¯è¯´æ˜ï¼‰ï¼Œè¾“å‡ºç»Ÿä¸€é£æ ¼æ¨¡æ¿ï¼ŒåŒ…æ‹¬è¯­æ°”ã€ç”¨è¯å±‚æ¬¡ã€ç¤ºä¾‹ç»“æ„ä¸é•¿åº¦èŒƒå›´ï¼Œå¯ç›´æ¥å¡«å……å¤ç”¨ã€‚åªè¾“å‡ºæ¨¡æ¿ç»“æœã€‚',
                    step2: 'è¯·ä»…è¾“å‡ºä½ çš„æ€è·¯ï¼Œè§£é‡Šé£æ ¼é€‰æ‹©ã€è¯­æ°”ä¸ç»“æ„çš„è®¾è®¡åŸåˆ™ã€‚'
                }
            };

            const DEFAULT_PRESETS = {
                'é€šç”¨ä¼˜åŒ–': 'ä½ æ˜¯ä¸€ä¸ªæç¤ºè¯ä¼˜åŒ–ä¸“å®¶ã€‚è¯·å°†ç”¨æˆ·çš„è¾“å…¥é‡å†™ä¸ºç»“æ„æ¸…æ™°ã€æŒ‡ä»¤æ˜ç¡®ã€é€»è¾‘ä¸¥å¯†ã€å¯Œæœ‰åˆ›é€ åŠ›çš„ promptã€‚ä¿æŒåŸæ„ï¼Œä½†æå‡ä¸“ä¸šåº¦å’Œå¯æ‰§è¡Œæ€§ã€‚',
                'ç¼–ç¨‹ä¸“å®¶': 'ä½ æ˜¯ä¸€ä½èµ„æ·±çš„è½¯ä»¶å¼€å‘å·¥ç¨‹å¸ˆï¼Œç²¾é€šå¤šç§ç¼–ç¨‹è¯­è¨€ã€‚è¯·ä»¥ä¸“ä¸šä¸”æ˜“æ‡‚çš„æ–¹å¼å›ç­”ç¼–ç¨‹é—®é¢˜ï¼Œæä¾›æœ€ä½³å®è·µä»£ç å’Œä¼˜åŒ–å»ºè®®ã€‚',
                'ä¸“ä¸šå†™ä½œ': 'ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å†™ä½œåŠ©æ‰‹ã€‚è¯·å¸®åŠ©ç”¨æˆ·åˆ›ä½œé«˜è´¨é‡çš„æ–‡ç« ã€æŠ¥å‘Šæˆ–æ–‡æ¡ˆï¼Œç¡®ä¿è¯­è¨€å‡†ç¡®ã€é€»è¾‘æ¸…æ™°ã€è¡¨è¾¾æµç•…ä¸”å¯Œæœ‰æ„ŸæŸ“åŠ›ã€‚',
                'è§’è‰²æ‰®æ¼”è®¾å®š': 'ä½ æ˜¯ä¸€ä½æç¤ºè¯ä¼˜åŒ–å·¥ç¨‹å¸ˆã€‚å°†è‡ªç„¶è¯­è¨€éœ€æ±‚è½¬æ¢ä¸ºç»“æ„æ¸…æ™°ã€ç»†èŠ‚ä¸°å¯Œçš„é«˜è´¨é‡æç¤ºè¯ï¼Œæå‡ç”Ÿæˆå†…å®¹çš„å‡†ç¡®æ€§ä¸ç»†èŠ‚åº¦ã€‚'
            };

            // State
            let appConfig = { ...DEFAULT_CONFIG };
            let promptPresets = {};
            let promptHelperPresets = {};
            let instructionPresets = {};
            let imageReversePresets = {};
            let instructionReversePresets = {};
            let activePresets = { prompt: null, 'prompt-helper': null, instruction: null, 'image-reverse': null, 'instruction-reverse': null };
            let currentModule = 'instruction'; // default to instruction
            const sharedViewState = {
                prompt: {
                    input: '',
                    output: '',
                    outputVisible: false,
                    indicatorVisible: false,
                    optimizeEnabled: false,
                    copyEnabled: false,
                    copyText: 'å¤åˆ¶',
                    charCount: '0 å­—ç¬¦',
                    reasoning: '',
                    reasoningVisible: false
                },
                instruction: {
                    input: '',
                    output: '',
                    outputVisible: false,
                    indicatorVisible: false,
                    optimizeEnabled: false,
                    copyEnabled: false,
                    copyText: 'å¤åˆ¶',
                    charCount: '0 å­—ç¬¦',
                    reasoning: '',
                    reasoningVisible: false
                }
            };
            let currentPresetType = 'instruction'; // default modal preset tab
            let isOptimizing = false;
            let uploadedImageBase64 = null;
            let uploadedImage1Base64 = null;
            let uploadedImage2Base64 = null;
            let editingPresetName = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„é¢„è®¾åç§°

            // DOM Elements
            const els = {
                tabPrompt: document.getElementById('tab-prompt'),
                tabInstruction: document.getElementById('tab-instruction'),
                tabImageReverse: document.getElementById('tab-image-reverse'),
                tabInstructionReverse: document.getElementById('tab-instruction-reverse'),
                tabPromptHelper: document.getElementById('tab-prompt-helper'),
                viewPrompt: document.getElementById('view-prompt'),
                viewPromptHelper: document.getElementById('view-prompt-helper'),
                viewImageReverse: document.getElementById('view-image-reverse'),
                viewInstructionReverse: document.getElementById('view-instruction-reverse'),

                // Settings Modal
                btnOpenSettings: document.getElementById('btn-open-settings'),
                btnCloseSettings: document.getElementById('btn-close-settings'),
                settingsModal: document.getElementById('settings-modal'),
                modalTabApi: document.getElementById('modal-tab-api'),
                modalTabPresets: document.getElementById('modal-tab-presets'),
                modalPanelApi: document.getElementById('modal-panel-api'),
                modalPanelPresets: document.getElementById('modal-panel-presets'),

                // Config Form (Inner Modal)
                inputApiKey: document.getElementById('input-api-key'),
                btnToggleKey: document.getElementById('btn-toggle-key'),
                selectBaseUrl: document.getElementById('select-base-url'),
                selectModel: document.getElementById('select-model'),
                inputCvAk: document.getElementById('input-cv-ak'),
                inputCvSk: document.getElementById('input-cv-sk'),
                btnSaveAllConfig: document.getElementById('btn-save-all-config'),

                // Processor
                inputPrompt: document.getElementById('input-prompt'),
                charCount: document.getElementById('char-count'),
                btnClearInput: document.getElementById('btn-clear-input'),
                outputPrompt: document.getElementById('output-prompt'),
                outputCharCount: document.getElementById('output-char-count'),
                outputPlaceholder: document.getElementById('output-placeholder'),
                outputIndicator: document.getElementById('output-indicator'),
                btnCopy: document.getElementById('btn-copy'),
                copyText: document.getElementById('copy-text'),
                btnOptimize: document.getElementById('btn-optimize'),
                btnText: document.getElementById('btn-text'),
                iconOptimize: document.getElementById('icon-optimize'),
                iconLoading: document.getElementById('icon-loading'),
                iconArrow: document.getElementById('icon-arrow'),
                reasoningCard: document.getElementById('reasoning-card'),
                reasoningContent: document.getElementById('reasoning-content'),
                btnCopyReasoning: document.getElementById('btn-copy-reasoning'),
                // Prompt Helper Processor
                inputPromptHelper: document.getElementById('input-prompt-helper'),
                charCountHelper: document.getElementById('char-count-helper'),
                btnClearInputHelper: document.getElementById('btn-clear-input-helper'),
                outputPromptHelper: document.getElementById('output-prompt-helper'),
                outputCharCountHelper: document.getElementById('output-char-count-helper'),
                outputPlaceholderHelper: document.getElementById('output-placeholder-helper'),
                outputIndicatorHelper: document.getElementById('output-indicator-helper'),
                btnCopyHelper: document.getElementById('btn-copy-helper'),
                copyTextHelper: document.getElementById('copy-text-helper'),
                btnOptimizeHelper: document.getElementById('btn-optimize-helper'),
                btnTextHelper: document.getElementById('btn-text-helper'),
                iconOptimizeHelper: document.getElementById('icon-optimize-helper'),
                iconLoadingHelper: document.getElementById('icon-loading-helper'),
                iconArrowHelper: document.getElementById('icon-arrow-helper'),
                reasoningCardHelper: document.getElementById('reasoning-card-helper'),
                reasoningContentHelper: document.getElementById('reasoning-content-helper'),
                btnCopyReasoningHelper: document.getElementById('btn-copy-reasoning-helper'),

                // Presets (Inner Modal)
                btnTogglePresetPrompt: document.getElementById('btn-toggle-preset-prompt'),
                btnTogglePresetPromptHelper: document.getElementById('btn-toggle-preset-prompt-helper'),
                btnTogglePresetInstruction: document.getElementById('btn-toggle-preset-instruction'),
                btnTogglePresetImageReverse: document.getElementById('btn-toggle-preset-image-reverse'),
                btnTogglePresetInstructionReverse: document.getElementById('btn-toggle-preset-instruction-reverse'),
                selectPreset: document.getElementById('select-preset'),
                inputPresetSearch: document.getElementById('input-preset-search'),
                presetsListContainer: document.getElementById('presets-list-container'),
                btnExportPresets: document.getElementById('btn-export-presets'),
                btnImportPresets: document.getElementById('btn-import-presets'),
                inputImportPresets: document.getElementById('input-import-presets'),
                presetEditor: document.getElementById('preset-editor'),
                editorTitle: document.getElementById('editor-title'),
                btnCancelEdit: document.getElementById('btn-cancel-edit'),
                btnNewPreset: document.getElementById('btn-new-preset'),
                presetNameContainer: document.getElementById('preset-name-container'),
                inputPresetName: document.getElementById('input-preset-name'),
                inputSystemPrompt: document.getElementById('input-system-prompt'),
                presetCharCount: document.getElementById('preset-char-count'),
                btnSavePreset: document.getElementById('btn-save-preset'),
                btnSaveText: document.getElementById('btn-save-text'),
                btnDeletePreset: document.getElementById('delete-preset-btn'),

                // Delete Confirmation Modal
                deleteModal: document.getElementById('delete-confirmation-modal'),
                btnCancelDelete: document.getElementById('cancel-delete-btn'),
                btnConfirmDelete: document.getElementById('confirm-delete-btn'),
                deleteMessage: document.getElementById('delete-modal-message'),
                currentPresetDisplayModal: document.getElementById('current-preset-display-modal'),
                currentPresetName: document.getElementById('current-preset-name'),
                currentPresetPreview: document.getElementById('current-preset-preview'),
                btnUseCurrentPreset: document.getElementById('btn-use-current-preset'),

                // Headers to swap
                workbenchTitle: document.getElementById('workbench-title'),
                workbenchSubtitle: document.getElementById('workbench-subtitle'),
                workbenchIcon: document.querySelector('#workbench-title').parentElement.parentElement.querySelector('i'),

                // Sidebar elements
                btnOpenSettingsFromSidebar: document.getElementById('btn-open-settings-from-sidebar'),
                presetNameDisplay: document.getElementById('preset-name-display'),
                presetPreview: document.getElementById('preset-preview'),
                tipsContent: document.getElementById('tips-content'),
                tipsTitle: document.getElementById('tips-title'),
                tipsSubtitle: document.getElementById('tips-subtitle'),
                // Prompt Helper sidebar
                btnOpenSettingsFromSidebarHelper: document.getElementById('btn-open-settings-from-sidebar-helper'),
                presetNameDisplayHelper: document.getElementById('preset-name-display-helper'),
                presetPreviewHelper: document.getElementById('preset-preview-helper'),
                tipsContentHelper: document.getElementById('tips-content-helper'),

                // Image Reverse Module
                inputImage: document.getElementById('input-image'),
                imageDropzone: document.getElementById('image-dropzone'),
                imagePreview: document.getElementById('image-preview'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                btnClearImage: document.getElementById('btn-clear-image'),
                outputImagePrompt: document.getElementById('output-image-prompt'),
                outputPlaceholderImage: document.getElementById('output-placeholder-image'),
                outputIndicatorImage: document.getElementById('output-indicator-image'),
                btnCopyImage: document.getElementById('btn-copy-image'),
                copyTextImage: document.getElementById('copy-text-image'),
                btnReverse: document.getElementById('btn-reverse'),
                btnTextImage: document.getElementById('btn-text-image'),
                iconReverse: document.getElementById('icon-reverse'),
                iconLoadingImage: document.getElementById('icon-loading-image'),
                iconArrowImage: document.getElementById('icon-arrow-image'),
                btnOpenSettingsFromSidebarImage: document.getElementById('btn-open-settings-from-sidebar-image'),
                presetNameDisplayImage: document.getElementById('preset-name-display-image'),
                presetPreviewImage: document.getElementById('preset-preview-image'),
                tipsContentImage: document.getElementById('tips-content-image'),

                // Instruction Reverse Module
                inputImage1: document.getElementById('input-image1'),
                inputImage2: document.getElementById('input-image2'),
                imageDropzone1: document.getElementById('image-dropzone1'),
                imageDropzone2: document.getElementById('image-dropzone2'),
                imagePreview1: document.getElementById('image-preview1'),
                imagePreview2: document.getElementById('image-preview2'),
                imagePreviewContainer1: document.getElementById('image-preview-container1'),
                imagePreviewContainer2: document.getElementById('image-preview-container2'),
                btnClearImage1: document.getElementById('btn-clear-image1'),
                btnClearImage2: document.getElementById('btn-clear-image2'),
                outputInstructionReverse: document.getElementById('output-instruction-reverse'),
                outputPlaceholderInstructionReverse: document.getElementById('output-placeholder-instruction-reverse'),
                outputIndicatorInstructionReverse: document.getElementById('output-indicator-instruction-reverse'),
                btnCopyInstructionReverse: document.getElementById('btn-copy-instruction-reverse'),
                copyTextInstructionReverse: document.getElementById('copy-text-instruction-reverse'),
                btnOptimizeInstructionReverse: document.getElementById('btn-optimize-instruction-reverse'),
                btnTextInstructionReverse: document.getElementById('btn-text-instruction-reverse'),
                iconOptimizeInstructionReverse: document.getElementById('icon-optimize-instruction-reverse'),
                iconLoadingInstructionReverse: document.getElementById('icon-loading-instruction-reverse'),
                iconArrowInstructionReverse: document.getElementById('icon-arrow-instruction-reverse'),
                btnOpenSettingsFromSidebarInstructionReverse: document.getElementById('btn-open-settings-from-sidebar-instruction-reverse'),
                presetNameDisplayInstructionReverse: document.getElementById('preset-name-display-instruction-reverse'),
                presetPreviewInstructionReverse: document.getElementById('preset-preview-instruction-reverse'),
                tipsContentInstructionReverse: document.getElementById('tips-content-instruction-reverse'),
                inputInstructionReverseText: document.getElementById('input-instruction-reverse-text'),
                instructionReverseCharCount: document.getElementById('instruction-reverse-char-count'),

                // Toast
                toast: document.getElementById('toast'),
                toastContent: document.getElementById('toast-content'),
                toastMessage: document.getElementById('toast-message'),
                toastIcon: document.getElementById('toast-icon'),

                // Usage Stats
                usageCounts: document.querySelectorAll('.usage-count-display')
            };

            let iconsUpdateScheduled = false;
            function scheduleIconsUpdate() {
                if (iconsUpdateScheduled) return;
                iconsUpdateScheduled = true;
                setTimeout(() => {
                    lucide.createIcons();
                    iconsUpdateScheduled = false;
                }, 50);
            }

            // --- Volcengine IAM Signature Implementation ---
            async function hmacSha256(key, data) {
                const encoder = new TextEncoder();
                const keyData = (key instanceof ArrayBuffer || ArrayBuffer.isView(key)) ? key : encoder.encode(key);
                const messageData = (typeof data === 'string') ? encoder.encode(data) : data;
                const cryptoKey = await window.crypto.subtle.importKey(
                    'raw', keyData, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
                );
                return await window.crypto.subtle.sign('HMAC', cryptoKey, messageData);
            }

            function hex(buffer) {
                return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            async function getVolcSignature(service, method, query, headers, body, ak, sk) {
                const region = 'cn-north-1';
                const now = new Date();
                const isoDate = now.toISOString().replace(/[:\-]|\.\d{3}/g, '');
                const date = isoDate.slice(0, 8);
                const credentialScope = `${date}/${region}/${service}/request`;

                // 1. Canonical Request
                const canonicalHeaders = Object.keys(headers)
                    .map(k => `${k.toLowerCase()}:${headers[k].trim()}`)
                    .sort()
                    .join('\n') + '\n';
                const signedHeaders = Object.keys(headers).map(k => k.toLowerCase()).sort().join(';');

                const bodyHash = hex(await window.crypto.subtle.digest('SHA-256', new TextEncoder().encode(body || '')));

                const canonicalRequest = [
                    method,
                    '/',
                    query,
                    canonicalHeaders,
                    signedHeaders,
                    bodyHash
                ].join('\n');

                // 2. String to Sign
                const stringToSign = [
                    'HMAC-SHA256',
                    isoDate,
                    credentialScope,
                    hex(await window.crypto.subtle.digest('SHA-256', new TextEncoder().encode(canonicalRequest)))
                ].join('\n');

                // 3. Signature
                let kDate = await hmacSha256(sk, date);
                let kRegion = await hmacSha256(kDate, region);
                let kService = await hmacSha256(kRegion, service);
                let kSigning = await hmacSha256(kService, 'request');
                const signature = hex(await hmacSha256(kSigning, stringToSign));

                return {
                    authorization: `HMAC-SHA256 Credential=${ak}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`,
                    xDate: isoDate
                };
            }

            // Logic functions
            function loadConfig() {
                const stored = localStorage.getItem(CONFIG_KEY);
                if (stored) {
                    try {
                        appConfig = { ...DEFAULT_CONFIG, ...JSON.parse(stored) };
                    } catch (e) { console.error('Failed to parse config', e); }
                }
            }

            function loadPresets() {
                const storedPrompt = localStorage.getItem(PRESETS_KEY);
                if (storedPrompt) {
                    try { promptPresets = JSON.parse(storedPrompt); } catch (e) { }
                }
                const storedPromptHelper = localStorage.getItem(PROMPT_HELPER_PRESETS_KEY);
                if (storedPromptHelper) {
                    try { promptHelperPresets = JSON.parse(storedPromptHelper); } catch (e) { }
                }
                const storedInstruction = localStorage.getItem(INSTRUCTION_PRESETS_KEY);
                if (storedInstruction) {
                    try { instructionPresets = JSON.parse(storedInstruction); } catch (e) { }
                }
                const storedImageReverse = localStorage.getItem(IMAGE_REVERSE_PRESETS_KEY);
                if (storedImageReverse) {
                    try { imageReversePresets = JSON.parse(storedImageReverse); } catch (e) { }
                }

                const storedInstructionReverse = localStorage.getItem(INSTRUCTION_REVERSE_PRESETS_KEY);
                if (storedInstructionReverse) {
                    try { instructionReversePresets = JSON.parse(storedInstructionReverse); } catch (e) { }
                }
                const storedActive = localStorage.getItem(ACTIVE_PRESETS_KEY);
                if (storedActive) {
                    try { activePresets = JSON.parse(storedActive); } catch (e) { }
                }

                // è¿ç§»é¢„è®¾ï¼Œç¡®ä¿åŒ…å«æœ€æ–°çš„æ ‡è®°é€»è¾‘
                migratePresets();
            }

            function migratePresets() {
                // å¦‚æœç”¨æˆ·æ²¡æœ‰â€œæŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶â€ï¼Œè‡ªåŠ¨åŠ ä¸Šï¼ˆåŸºäºæœ€æ–°å®šä¹‰ï¼‰
                if (!instructionPresets['æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶']) {
                    console.log('Migrating: Adding missing æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶ preset');
                    instructionPresets['æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶'] = DEFAULT_INSTRUCTION_PRESETS['æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶'];
                    localStorage.setItem(INSTRUCTION_PRESETS_KEY, JSON.stringify(instructionPresets));
                }

                const OLD_INSTRUCTION_EXPERT = 'ä½ æ˜¯ä¸€ä¸ªæŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶ã€‚è¯·æ·±åº¦åˆ†æç”¨æˆ·çš„åŸå§‹æŒ‡ä»¤ï¼Œè¯†åˆ«å…¶ä¸­çš„æ¨¡ç³Šã€æ­§ä¹‰æˆ–é€»è¾‘æ¼æ´ã€‚è¯·é‡å†™è¯¥æŒ‡ä»¤ï¼Œä½¿å…¶å…·å¤‡ï¼š\n1. æ˜ç¡®çš„ç›®æ ‡å¯¼å‘\n2. æ¸…æ™°çš„æ­¥éª¤æˆ–çº¦æŸæ¡ä»¶\n3. å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯\n4. ä¸“ä¸šçš„è¡¨è¾¾æ–¹å¼\nç¡®ä¿ä¼˜åŒ–åçš„æŒ‡ä»¤èƒ½å¼•å‘ AI äº§ç”Ÿæœ€é«˜è´¨é‡çš„è¾“å‡ºã€‚';
                if (instructionPresets['æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶'] === OLD_INSTRUCTION_EXPERT) {
                    console.log('Migrating: Updating old æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶ preset');
                    instructionPresets['æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶'] = DEFAULT_INSTRUCTION_PRESETS['æŒ‡ä»¤ä¼˜åŒ–ä¸“å®¶'];
                    localStorage.setItem(INSTRUCTION_PRESETS_KEY, JSON.stringify(instructionPresets));
                }

                // å¯¹â€œç»“æ„åŒ–å¸®å†™â€è¿›è¡ŒåŒæ ·çš„æ“ä½œ
                if (!promptHelperPresets['ç»“æ„åŒ–å¸®å†™']) {
                    console.log('Migrating: Adding missing ç»“æ„åŒ–å¸®å†™ preset');
                    promptHelperPresets['ç»“æ„åŒ–å¸®å†™'] = DEFAULT_PROMPT_HELPER_PRESETS['ç»“æ„åŒ–å¸®å†™'];
                    localStorage.setItem(PROMPT_HELPER_PRESETS_KEY, JSON.stringify(promptHelperPresets));
                }
                const OLD_STRUCT_HELPER = 'ä½ æ˜¯ä¸€åæç¤ºè¯å¸®å†™ä¸“å®¶ã€‚æ ¹æ®ç”¨æˆ·çš„åŸå§‹è¾“å…¥ï¼Œç”Ÿæˆç»“æ„æ¸…æ™°ã€å¯å¤ç”¨çš„æç¤ºè¯è‰ç¨¿ã€‚åŒ…å«ï¼šç›®æ ‡ã€ä¸Šä¸‹æ–‡ã€è§’è‰²/èƒ½åŠ›ã€è¾“å…¥çº¦æŸã€è¾“å‡ºæ ¼å¼ã€é£æ ¼ä¸é•¿åº¦ã€è¯„ä¼°æ ‡å‡†ã€‚';
                if (promptHelperPresets['ç»“æ„åŒ–å¸®å†™'] === OLD_STRUCT_HELPER) {
                    console.log('Migrating: Updating old ç»“æ„åŒ–å¸®å†™ preset');
                    promptHelperPresets['ç»“æ„åŒ–å¸®å†™'] = DEFAULT_PROMPT_HELPER_PRESETS['ç»“æ„åŒ–å¸®å†™'];
                    localStorage.setItem(PROMPT_HELPER_PRESETS_KEY, JSON.stringify(promptHelperPresets));
                }
            }

            function saveConfig() {
                localStorage.setItem(CONFIG_KEY, JSON.stringify(appConfig));
                updateConfigUI();
            }

            function savePresetsData() {
                if (currentPresetType === 'prompt') {
                    localStorage.setItem(PRESETS_KEY, JSON.stringify(promptPresets));
                } else if (currentPresetType === 'prompt-helper') {
                    localStorage.setItem(PROMPT_HELPER_PRESETS_KEY, JSON.stringify(promptHelperPresets));
                } else if (currentPresetType === 'instruction') {
                    localStorage.setItem(INSTRUCTION_PRESETS_KEY, JSON.stringify(instructionPresets));
                } else if (currentPresetType === 'image-reverse') {
                    localStorage.setItem(IMAGE_REVERSE_PRESETS_KEY, JSON.stringify(imageReversePresets));
                } else if (currentPresetType === 'instruction-reverse') {
                    localStorage.setItem(INSTRUCTION_REVERSE_PRESETS_KEY, JSON.stringify(instructionReversePresets));
                }
                updateSidebarPreset();
            }
            function clearAllPresets() {
                promptPresets = {};
                promptHelperPresets = {};
                instructionPresets = {};
                imageReversePresets = {};
                instructionReversePresets = {};
                activePresets = { prompt: null, 'prompt-helper': null, instruction: null, 'image-reverse': null, 'instruction-reverse': null };
                try {
                    localStorage.removeItem(PRESETS_KEY);
                    localStorage.removeItem(PROMPT_HELPER_PRESETS_KEY);
                    localStorage.removeItem(INSTRUCTION_PRESETS_KEY);
                    localStorage.removeItem(IMAGE_REVERSE_PRESETS_KEY);
                    localStorage.removeItem(INSTRUCTION_REVERSE_PRESETS_KEY);
                    localStorage.removeItem(ACTIVE_PRESETS_KEY);
                } catch (e) { }
                renderPresets();
                updateSidebarPreset();
                updateCurrentPresetDisplay();
                showToast('æ‰€æœ‰é¢„è®¾å·²æ¸…é™¤', 'success');
            }

            function renderPresets() {
                // æ ¹æ®å½“å‰é¢„è®¾ç±»å‹ä¸¥æ ¼è¿‡æ»¤ï¼Œåªæ˜¾ç¤ºå½“å‰ç±»å‹çš„é¢„è®¾
                const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                    (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                        (currentPresetType === 'prompt-helper') ? promptHelperPresets :
                            (currentPresetType === 'instruction') ? instructionPresets : promptPresets;

                const activePreset = activePresets[currentPresetType];

                // è·å–å½“å‰ç±»å‹çš„æ‰€æœ‰é¢„è®¾ï¼ˆä¸¥æ ¼è¿‡æ»¤ï¼Œä¸åŒ…å«å…¶ä»–ç±»å‹ï¼‰
                let presetKeys = Object.keys(presets).sort();

                // æ¸…ç©ºåˆ—è¡¨å®¹å™¨ï¼ˆç¡®ä¿ä¸æ˜¾ç¤ºå…¶ä»–ç±»å‹çš„é¢„è®¾ï¼‰
                if (els.presetsListContainer) {
                    els.presetsListContainer.innerHTML = '';

                    // å¦‚æœæ˜¯æ–°å»ºæ¨¡å¼ï¼Œä¼˜å…ˆæ¸²æŸ“ä¸€ä¸ªç´§å‡‘çš„æ–°å»ºå¡ç‰‡
                    if (editingPresetName === '__new__') {
                        const newCard = document.createElement('div');
                        newCard.className = 'preset-card bg-white border-2 border-dashed border-indigo-300 rounded-xl mb-3';
                        {
                            const isTwoStep = (currentPresetType === 'instruction' || currentPresetType === 'prompt-helper');
                            const newHTML = isTwoStep ? `
                                <div class="p-3 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-1.5">
                                            <i data-lucide="plus-circle" class="w-3.5 h-3.5 text-indigo-600"></i>
                                            <span class="text-xs font-semibold text-slate-700">æ–°å»ºé¢„è®¾ï¼ˆåˆ†æ­¥ï¼‰</span>
                                        </div>
                                        <button class="preset-cancel-new-btn p-1 text-slate-400 hover:text-slate-600 rounded transition-all" title="å–æ¶ˆ">
                                            <i data-lucide="x" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                    <div class="space-y-1.5">
                                        <input type="text" class="preset-new-name-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none" 
                                            placeholder="é¢„è®¾åç§°">
                                    </div>
                                    <div class="space-y-1.5">
                                        <label class="text-[10px] text-slate-500">Step1ï¼ˆä¼˜åŒ–ç»“æœçš„ç³»ç»Ÿæç¤ºè¯ï¼‰</label>
                                        <textarea class="preset-new-step1-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono leading-relaxed focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none resize-none" 
                                            rows="4" placeholder="ç”¨äºç”Ÿæˆä¼˜åŒ–ç»“æœçš„ç³»ç»Ÿæç¤ºè¯..."></textarea>
                                        <div class="flex items-center justify-between text-[10px] text-slate-400 px-0.5">
                                            <span class="preset-new-step1-char">0 å­—ç¬¦</span>
                                        </div>
                                    </div>
                                    <div class="space-y-1.5">
                                        <label class="text-[10px] text-slate-500">Step2ï¼ˆä¼˜åŒ–æ€è·¯çš„ç³»ç»Ÿæç¤ºè¯ï¼‰</label>
                                        <textarea class="preset-new-step2-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono leading-relaxed focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none resize-none" 
                                            rows="4" placeholder="ç”¨äºç”Ÿæˆä¼˜åŒ–æ€è·¯çš„ç³»ç»Ÿæç¤ºè¯..."></textarea>
                                        <div class="flex items-center justify-between text-[10px] text-slate-400 px-0.5">
                                            <span class="preset-new-step2-char">0 å­—ç¬¦</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 pt-1">
                                        <button class="preset-save-new-btn flex-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700 transition-all">
                                            <i data-lucide="save" class="w-3 h-3 inline-block mr-1"></i>
                                            ä¿å­˜
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="p-3 space-y-3">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-1.5">
                                            <i data-lucide="plus-circle" class="w-3.5 h-3.5 text-indigo-600"></i>
                                            <span class="text-xs font-semibold text-slate-700">æ–°å»ºé¢„è®¾</span>
                                        </div>
                                        <button class="preset-cancel-new-btn p-1 text-slate-400 hover:text-slate-600 rounded transition-all" title="å–æ¶ˆ">
                                            <i data-lucide="x" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                    <div class="space-y-1.5">
                                        <input type="text" class="preset-new-name-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none" 
                                            placeholder="é¢„è®¾åç§°">
                                    </div>
                                    <div class="space-y-1.5">
                                        <textarea class="preset-new-content-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono leading-relaxed focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none resize-none" 
                                            rows="4" placeholder="ç³»ç»Ÿæç¤ºè¯..."></textarea>
                                        <div class="flex items-center justify-between text-[10px] text-slate-400 px-0.5">
                                            <span class="preset-new-char-count">0 å­—ç¬¦</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2 pt-1">
                                        <button class="preset-save-new-btn flex-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700 transition-all">
                                            <i data-lucide="save" class="w-3 h-3 inline-block mr-1"></i>
                                            ä¿å­˜
                                        </button>
                                    </div>
                                </div>
                            `;
                            newCard.innerHTML = newHTML;
                        }

                        // å­—ç¬¦è®¡æ•°
                        const textareaNew = newCard.querySelector('.preset-new-content-input');
                        const charCountNew = newCard.querySelector('.preset-new-char-count');
                        const step1Input = newCard.querySelector('.preset-new-step1-input');
                        const step2Input = newCard.querySelector('.preset-new-step2-input');
                        const step1Count = newCard.querySelector('.preset-new-step1-char');
                        const step2Count = newCard.querySelector('.preset-new-step2-char');
                        if (textareaNew && charCountNew) {
                            textareaNew.addEventListener('input', () => {
                                charCountNew.textContent = `${textareaNew.value.length} å­—ç¬¦`;
                            });
                        }
                        if (step1Input && step1Count) {
                            step1Input.addEventListener('input', () => {
                                step1Count.textContent = `${step1Input.value.length} å­—ç¬¦`;
                            });
                        }
                        if (step2Input && step2Count) {
                            step2Input.addEventListener('input', () => {
                                step2Count.textContent = `${step2Input.value.length} å­—ç¬¦`;
                            });
                        }

                        // ä¿å­˜æ–°é¢„è®¾
                        newCard.querySelector('.preset-save-new-btn').addEventListener('click', () => {
                            const name = newCard.querySelector('.preset-new-name-input').value.trim();
                            if (!name) {
                                showToast('è¯·è¾“å…¥é¢„è®¾åç§°', 'error');
                                return;
                            }
                            if (presets[name]) {
                                showToast('é¢„è®¾åç§°å·²å­˜åœ¨', 'error');
                                return;
                            }
                            if (isTwoStep && step1Input && step2Input) {
                                const s1 = step1Input.value.trim();
                                const s2 = step2Input.value.trim();
                                if (!s1 || !s2) {
                                    showToast('è¯·å¡«å†™ Step1 ä¸ Step2 çš„ç³»ç»Ÿæç¤ºè¯', 'error');
                                    return;
                                }
                                presets[name] = { step1: s1, step2: s2 };
                            } else {
                                const content = textareaNew ? textareaNew.value.trim() : '';
                                if (!content) {
                                    showToast('è¯·è¾“å…¥ç³»ç»Ÿæç¤ºè¯', 'error');
                                    return;
                                }
                                presets[name] = content;
                            }
                            savePresetsData();
                            editingPresetName = null;
                            renderPresets();
                            showToast(`é¢„è®¾ "${name}" å·²åˆ›å»º`, 'success');
                        });

                        // å–æ¶ˆæ–°å»º
                        newCard.querySelector('.preset-cancel-new-btn').addEventListener('click', () => {
                            editingPresetName = null;
                            renderPresets();
                        });

                        els.presetsListContainer.appendChild(newCard);
                        scheduleIconsUpdate();
                    }

                    // å¦‚æœæ—¢æ²¡æœ‰é¢„è®¾ä¹Ÿä¸åœ¨æ–°å»ºæ¨¡å¼ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€ï¼ˆåªæ˜¾ç¤ºå½“å‰ç±»å‹çš„æç¤ºï¼‰
                    if (presetKeys.length === 0 && editingPresetName !== '__new__') {
                        const presetTypeName = currentPresetType === 'instruction' ? 'æŒ‡ä»¤ä¼˜åŒ–' :
                            currentPresetType === 'image-reverse' ? 'å›¾åƒåæ¨' :
                                currentPresetType === 'instruction-reverse' ? 'æŒ‡ä»¤åæ¨' : 'å½“å‰ç±»å‹';
                        els.presetsListContainer.innerHTML = `
                        <div class="text-center py-8 text-slate-400">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-30"></i>
                            <p class="text-sm font-medium mb-1">${presetTypeName}æš‚æ— é¢„è®¾</p>
                            <p class="text-xs text-slate-400">ç‚¹å‡»ä¸Šæ–¹"æ–°å»ºé¢„è®¾"å¼€å§‹åˆ›å»º</p>
                        </div>
                    `;
                        scheduleIconsUpdate();
                        return;
                    }

                    // æ¸²æŸ“é¢„è®¾å¡ç‰‡ï¼ˆåªæ¸²æŸ“å½“å‰ç±»å‹çš„é¢„è®¾ï¼Œåœ¨æ–°å»ºå¡ç‰‡ä¹‹åï¼‰
                    presetKeys.forEach(name => {
                        const isActive = activePreset === name;
                        const content = presets[name];
                        const previewSource = getPresetPreviewText(content);
                        const preview = previewSource.length > 100 ? previewSource.substring(0, 100) + '...' : previewSource;
                        const isEditing = editingPresetName === name;

                        const card = document.createElement('div');
                        card.className = `preset-card bg-white border-2 rounded-xl transition-all ${isActive ? 'border-indigo-500 bg-indigo-50/30' : 'border-slate-200 hover:border-indigo-300'
                            } ${isEditing ? 'shadow-lg' : ''}`;
                        card.dataset.presetName = name;

                        if (isEditing) {
                            // ç¼–è¾‘æ¨¡å¼ï¼šæ˜¾ç¤ºç¼–è¾‘è¡¨å•
                            const isTwoStep = (currentPresetType === 'instruction' || currentPresetType === 'prompt-helper');
                            const isObj = typeof content === 'object' && content;
                            const editHTML = isTwoStep ? `
                                    <div class="p-3 space-y-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-1.5">
                                                <i data-lucide="edit-3" class="w-3.5 h-3.5 text-indigo-600"></i>
                                                <span class="text-xs font-semibold text-slate-700">ç¼–è¾‘é¢„è®¾ï¼ˆåˆ†æ­¥ï¼‰</span>
                                            </div>
                                            <button class="preset-cancel-edit-btn p-1 text-slate-400 hover:text-slate-600 rounded transition-all" title="å–æ¶ˆ">
                                                <i data-lucide="x" class="w-3.5 h-3.5"></i>
                                            </button>
                                        </div>
                                        <div class="space-y-1.5">
                                            <input type="text" class="preset-edit-name-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none" 
                                                value="${name}" placeholder="é¢„è®¾åç§°">
                                        </div>
                                        <div class="space-y-1.5">
                                            <label class="text-[10px] text-slate-500">Step1ï¼ˆä¼˜åŒ–ç»“æœçš„ç³»ç»Ÿæç¤ºè¯ï¼‰</label>
                                            <textarea class="preset-edit-step1-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono leading-relaxed focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none resize-none" 
                                                rows="4" placeholder="ç”¨äºç”Ÿæˆä¼˜åŒ–ç»“æœçš„ç³»ç»Ÿæç¤ºè¯...">${isObj ? (content.step1 || '') : (content || '')}</textarea>
                                            <div class="flex items-center justify-between text-[10px] text-slate-400 px-0.5">
                                                <span class="preset-step1-char">${isObj ? ((content.step1 || '').length) : (String(content || '').length)} å­—ç¬¦</span>
                                            </div>
                                        </div>
                                        <div class="space-y-1.5">
                                            <label class="text-[10px] text-slate-500">Step2ï¼ˆä¼˜åŒ–æ€è·¯çš„ç³»ç»Ÿæç¤ºè¯ï¼‰</label>
                                            <textarea class="preset-edit-step2-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono leading-relaxed focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none resize-none" 
                                                rows="4" placeholder="ç”¨äºç”Ÿæˆä¼˜åŒ–æ€è·¯çš„ç³»ç»Ÿæç¤ºè¯...">${isObj ? (content.step2 || '') : ''}</textarea>
                                            <div class="flex items-center justify-between text-[10px] text-slate-400 px-0.5">
                                                <span class="preset-step2-char">${isObj ? ((content.step2 || '').length) : 0} å­—ç¬¦</span>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 pt-1">
                                            <button class="preset-save-btn flex-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700 transition-all">
                                                <i data-lucide="save" class="w-3 h-3 inline-block mr-1"></i>
                                                ä¿å­˜
                                            </button>
                                            <button class="preset-delete-btn px-3 py-1.5 text-red-600 bg-red-50 border border-red-200 text-xs font-semibold rounded-lg hover:bg-red-100 transition-all">
                                                <i data-lucide="trash-2" class="w-3 h-3 inline-block mr-1"></i>
                                                åˆ é™¤
                                            </button>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="p-3 space-y-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-1.5">
                                                <i data-lucide="edit-3" class="w-3.5 h-3.5 text-indigo-600"></i>
                                                <span class="text-xs font-semibold text-slate-700">ç¼–è¾‘é¢„è®¾</span>
                                            </div>
                                            <button class="preset-cancel-edit-btn p-1 text-slate-400 hover:text-slate-600 rounded transition-all" title="å–æ¶ˆ">
                                                <i data-lucide="x" class="w-3.5 h-3.5"></i>
                                            </button>
                                        </div>
                                        <div class="space-y-1.5">
                                            <input type="text" class="preset-edit-name-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none" 
                                                value="${name}" placeholder="é¢„è®¾åç§°">
                                        </div>
                                        <div class="space-y-1.5">
                                            <textarea class="preset-edit-content-input w-full px-2.5 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono leading-relaxed focus:ring-1 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none resize-none" 
                                                rows="4" placeholder="ç³»ç»Ÿæç¤ºè¯...">${content}</textarea>
                                            <div class="flex items-center justify-between text-[10px] text-slate-400 px-0.5">
                                                <span class="preset-char-count">${String(content || '').length} å­—ç¬¦</span>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 pt-1">
                                            <button class="preset-save-btn flex-1 px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700 transition-all">
                                                <i data-lucide="save" class="w-3 h-3 inline-block mr-1"></i>
                                                ä¿å­˜
                                            </button>
                                            <button class="preset-delete-btn px-3 py-1.5 text-red-600 bg-red-50 border border-red-200 text-xs font-semibold rounded-lg hover:bg-red-100 transition-all">
                                                <i data-lucide="trash-2" class="w-3 h-3 inline-block mr-1"></i>
                                                åˆ é™¤
                                            </button>
                                        </div>
                                    </div>
                                `;
                            card.innerHTML = editHTML;

                            // å­—ç¬¦è®¡æ•°
                            const textarea = card.querySelector('.preset-edit-content-input');
                            const charCount = card.querySelector('.preset-char-count');
                            const step1Input = card.querySelector('.preset-edit-step1-input');
                            const step2Input = card.querySelector('.preset-edit-step2-input');
                            const step1Count = card.querySelector('.preset-step1-char');
                            const step2Count = card.querySelector('.preset-step2-char');
                            if (textarea && charCount) {
                                textarea.addEventListener('input', () => {
                                    charCount.textContent = `${textarea.value.length} å­—ç¬¦`;
                                });
                            }
                            if (step1Input && step1Count) {
                                step1Input.addEventListener('input', () => {
                                    step1Count.textContent = `${step1Input.value.length} å­—ç¬¦`;
                                });
                            }
                            if (step2Input && step2Count) {
                                step2Input.addEventListener('input', () => {
                                    step2Count.textContent = `${step2Input.value.length} å­—ç¬¦`;
                                });
                            }

                            // ä¿å­˜æŒ‰é’®
                            card.querySelector('.preset-save-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                const newName = card.querySelector('.preset-edit-name-input').value.trim();
                                const newContentInput = card.querySelector('.preset-edit-content-input');
                                const newStep1Input = card.querySelector('.preset-edit-step1-input');
                                const newStep2Input = card.querySelector('.preset-edit-step2-input');

                                if (!newName) {
                                    showToast('è¯·è¾“å…¥é¢„è®¾åç§°', 'error');
                                    return;
                                }
                                let newValue;
                                if (isTwoStep && newStep1Input && newStep2Input) {
                                    const s1 = newStep1Input.value.trim();
                                    const s2 = newStep2Input.value.trim();
                                    if (!s1 || !s2) {
                                        showToast('è¯·å¡«å†™ Step1 ä¸ Step2 çš„ç³»ç»Ÿæç¤ºè¯', 'error');
                                        return;
                                    }
                                    newValue = { step1: s1, step2: s2 };
                                } else {
                                    const newContent = newContentInput ? newContentInput.value.trim() : '';
                                    if (!newContent) {
                                        showToast('è¯·è¾“å…¥ç³»ç»Ÿæç¤ºè¯', 'error');
                                        return;
                                    }
                                    newValue = newContent;
                                }

                                // å¦‚æœåç§°æ”¹å˜ï¼Œéœ€è¦åˆ é™¤æ—§åç§°
                                if (newName !== name) {
                                    delete presets[name];
                                    if (activePresets[currentPresetType] === name) {
                                        activePresets[currentPresetType] = newName;
                                    }
                                }

                                presets[newName] = newValue;
                                savePresetsData();
                                editingPresetName = null;
                                renderPresets();
                                showToast(`é¢„è®¾ "${newName}" å·²ä¿å­˜`, 'success');
                            });

                            // å–æ¶ˆæŒ‰é’®
                            card.querySelector('.preset-cancel-edit-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                editingPresetName = null;
                                renderPresets();
                            });

                            // åˆ é™¤æŒ‰é’®
                            card.querySelector('.preset-delete-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                deletePreset(name);
                            });

                            // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
                            setTimeout(() => {
                                card.querySelector('.preset-edit-name-input').focus();
                            }, 100);
                        } else {
                            // æ˜¾ç¤ºæ¨¡å¼ï¼šæ˜¾ç¤ºé¢„è®¾ä¿¡æ¯
                            card.innerHTML = `
                            <div class="p-4">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h5 class="font-bold text-slate-800 text-sm truncate">${name}</h5>
                                            <span class="preset-active-badge px-2 py-0.5 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full inline-flex items-center justify-center min-w-[64px] ${isActive ? '' : 'opacity-0'}">å½“å‰ä½¿ç”¨</span>
                                        </div>
                                        <p class="text-xs text-slate-600 line-clamp-3 leading-relaxed">${preview}</p>
                                    </div>
                                    <div class="flex items-center gap-1 flex-shrink-0">
                                        <button class="preset-use-btn p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all" 
                                            data-preset-name="${name}" title="ä½¿ç”¨">
                                            <i data-lucide="check" class="w-4 h-4"></i>
                                        </button>
                                        <button class="preset-edit-btn p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all" 
                                            data-preset-name="${name}" title="ç¼–è¾‘">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button class="preset-delete-btn p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all" 
                                            data-preset-name="${name}" title="åˆ é™¤">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                            // ç‚¹å‡»å¡ç‰‡é€‰æ‹©é¢„è®¾
                            card.addEventListener('click', (e) => {
                                if (!e.target.closest('.preset-edit-btn') && !e.target.closest('.preset-delete-btn')) {
                                    selectPreset(name);
                                }
                            });

                            // ä½¿ç”¨æŒ‰é’®
                            card.querySelector('.preset-use-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                selectPreset(name);
                            });
                            // ç¼–è¾‘æŒ‰é’®
                            card.querySelector('.preset-edit-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                editingPresetName = name;
                                renderPresets();
                            });

                            // åˆ é™¤æŒ‰é’®
                            card.querySelector('.preset-delete-btn').addEventListener('click', (e) => {
                                e.stopPropagation();
                                deletePreset(name);
                            });
                        }

                        els.presetsListContainer.appendChild(card);
                    });

                    scheduleIconsUpdate();
                }

                // æ›´æ–°å½“å‰é¢„è®¾æ˜¾ç¤º
                updateCurrentPresetDisplay();

                // å…¼å®¹æ—§çš„ select å…ƒç´ ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (els.selectPreset) {
                    const selected = els.selectPreset.value;
                    els.selectPreset.innerHTML = '<option value="">-- æ–°å»º / è‡ªå®šä¹‰ --</option>';
                    presetKeys.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        els.selectPreset.appendChild(option);
                    });
                    if (selected && presets[selected]) {
                        els.selectPreset.value = selected;
                    }
                }
            }

            function updateCurrentPresetDisplay() {
                if (!els.currentPresetName || !els.currentPresetPreview) return;

                const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                    (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                        (currentPresetType === 'prompt-helper') ? promptHelperPresets :
                            (currentPresetType === 'instruction') ? instructionPresets : promptPresets;

                const activePreset = activePresets[currentPresetType];

                if (activePreset && presets[activePreset]) {
                    els.currentPresetName.textContent = activePreset;
                    const previewRaw = presets[activePreset];
                    const previewText = getPresetPreviewText(previewRaw);
                    els.currentPresetPreview.textContent = previewText.length > 150 ? previewText.substring(0, 150) + '...' : previewText;
                    els.btnUseCurrentPreset.classList.remove('hidden');
                } else {
                    els.currentPresetName.textContent = 'æš‚æ— é¢„è®¾';
                    els.currentPresetPreview.textContent = 'è¯·ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªé¢„è®¾ï¼Œæˆ–åˆ›å»ºæ–°é¢„è®¾';
                    els.btnUseCurrentPreset.classList.add('hidden');
                }
            }

            function selectPreset(name) {
                const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                    (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                        (currentPresetType === 'prompt-helper') ? promptHelperPresets :
                            (currentPresetType === 'instruction') ? instructionPresets : promptPresets;

                if (presets[name]) {
                    // è®¾ç½®ä¸ºæ´»åŠ¨é¢„è®¾
                    activePresets[currentPresetType] = name;
                    localStorage.setItem(ACTIVE_PRESETS_KEY, JSON.stringify(activePresets));
                    updateSidebarPreset();
                    renderPresets(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°"å½“å‰ä½¿ç”¨"æ ‡è®°
                    updateCurrentPresetDisplay(); // æ›´æ–°å³ä¾§å½“å‰é¢„è®¾æ˜¾ç¤º
                    showToast(`å·²åˆ‡æ¢åˆ°é¢„è®¾ "${name}"`, 'success');
                }
            }

            function editPreset(name) {
                const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                    (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                        (currentPresetType === 'prompt-helper') ? promptHelperPresets :
                            (currentPresetType === 'instruction') ? instructionPresets : promptPresets;

                if (presets[name]) {
                    els.inputPresetName.value = name;
                    els.inputSystemPrompt.value = presets[name];
                    els.presetNameContainer.classList.add('hidden');
                    els.btnDeletePreset.classList.remove('hidden');
                    els.btnCancelEdit.classList.remove('hidden');
                    els.editorTitle.textContent = `ç¼–è¾‘é¢„è®¾: ${name}`;
                    els.btnSaveText.textContent = 'ä¿å­˜æ›´æ”¹';

                    // æ›´æ–°å­—ç¬¦è®¡æ•°
                    updatePresetCharCount();

                    // æ»šåŠ¨åˆ°ç¼–è¾‘å™¨
                    els.presetEditor.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    els.inputSystemPrompt.focus();
                }
            }

            let presetToDelete = null;

            function showDeleteConfirmation(name) {
                presetToDelete = name;
                els.deleteMessage.textContent = `ç¡®å®šè¦åˆ é™¤é¢„è®¾ "${name}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`;
                els.deleteModal.classList.remove('hidden');
                if (els.btnConfirmDelete) {
                    els.btnConfirmDelete.disabled = false;
                    els.btnConfirmDelete.innerHTML = `<i data-lucide="trash-2" class="w-4 h-4"></i> ç¡®è®¤åˆ é™¤`;
                    scheduleIconsUpdate();
                }
            }

            function hideDeleteConfirmation() {
                presetToDelete = null;
                els.deleteModal.classList.add('hidden');
            }

            function executeDeletePreset() {
                if (!presetToDelete) return;
                const name = presetToDelete;
                if (els.btnConfirmDelete) {
                    els.btnConfirmDelete.disabled = true;
                    els.btnConfirmDelete.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> æ­£åœ¨åˆ é™¤...`;
                    scheduleIconsUpdate();
                }

                const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                    (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                        (currentPresetType === 'prompt-helper') ? promptHelperPresets :
                            (currentPresetType === 'instruction') ? instructionPresets : promptPresets;

                delete presets[name];

                // å¦‚æœåˆ é™¤çš„æ˜¯æ´»åŠ¨é¢„è®¾ï¼Œæ¸…é™¤æ´»åŠ¨çŠ¶æ€
                if (activePresets[currentPresetType] === name) {
                    activePresets[currentPresetType] = null;
                }

                savePresetsData();
                renderPresets();
                resetPresetForm();
                updateCurrentPresetDisplay();
                showToast(`é¢„è®¾ "${name}" å·²åˆ é™¤`, 'success');
                hideDeleteConfirmation();
            }

            function deletePreset(name) {
                showDeleteConfirmation(name);
            }

            // é€‰ä¸­å¹¶å±•ç¤ºå½“å‰ç±»å‹ä¸‹çš„ç¬¬ä¸€ä¸ªé¢„è®¾ï¼ˆç”¨äºâ€œé¢„è®¾ç®¡ç†â€åˆæ¬¡æ‰“å¼€æ—¶çš„é»˜è®¤å±•ç¤ºï¼‰
            function applyDefaultPresetSelection() {
                const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                    (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                        (currentPresetType === 'prompt-helper') ? promptHelperPresets :
                            (currentPresetType === 'instruction') ? instructionPresets : promptPresets;
                const keys = Object.keys(presets).sort();

                if (keys.length === 0) {
                    resetPresetForm();
                    return;
                }

                // Prefer active preset if valid
                let name = keys[0];
                const active = activePresets[currentPresetType];
                if (active && presets[active]) {
                    name = active;
                }

                if (els.selectPreset) els.selectPreset.value = name;
                if (els.inputSystemPrompt) els.inputSystemPrompt.value = presets[name] || '';
                if (els.inputPresetName) els.inputPresetName.value = name;
                if (els.presetNameContainer) els.presetNameContainer.classList.add('hidden');
                if (els.btnDeletePreset) els.btnDeletePreset.classList.remove('hidden');
                updateSaveButtonState();
            }

            function updateConfigUI() {
                if (els.inputApiKey) els.inputApiKey.value = appConfig.apiKey || '';
                if (els.selectBaseUrl) els.selectBaseUrl.value = appConfig.baseURL || '';
                if (els.inputCvAk) els.inputCvAk.value = appConfig.cvAK || '';
                if (els.inputCvSk) els.inputCvSk.value = appConfig.cvSK || '';

                if (els.selectBaseUrl) {
                    const event = new Event('change');
                    els.selectBaseUrl.dispatchEvent(event);
                }

                setTimeout(() => {
                    if (!els.selectModel) return;
                    els.selectModel.value = appConfig.model || '';
                    if (!els.selectModel.value) {
                        const baseURL = appConfig.baseURL || '';
                        if (baseURL.includes('google') || baseURL.includes('googleapis.com')) {
                            els.selectModel.value = 'gemini-1.5-flash';
                        } else if (baseURL.includes('siliconflow')) {
                            els.selectModel.value = 'Qwen/Qwen2-VL-72B-Instruct';
                        } else if (baseURL.includes('openai') || baseURL.includes('api.openai.com')) {
                            els.selectModel.value = 'gpt-4o';
                        } else if (baseURL.includes('deepseek')) {
                            els.selectModel.value = 'deepseek-chat';
                        } else {
                            els.selectModel.value = 'ep-20251030180013-p4bww';
                        }
                    }
                }, 0);
            }

            function setupEventListeners() {
                // Modal Toggles
                els.btnOpenSettings.addEventListener('click', () => {
                    els.settingsModal.classList.remove('hidden');
                    updateConfigUI();
                    editingPresetName = null;
                    // Set preset type based on current app tab
                    if (currentModule === 'instruction') {
                        currentPresetType = 'instruction';
                    } else if (currentModule === 'image-reverse') {
                        currentPresetType = 'image-reverse';
                    } else if (currentModule === 'instruction-reverse') {
                        currentPresetType = 'instruction-reverse';
                    } else {
                        currentPresetType = 'instruction'; // é»˜è®¤ä½¿ç”¨æŒ‡ä»¤ä¼˜åŒ–
                    }
                    updatePresetToggleUI();
                    renderPresets();
                });

                // Sidebar settings button
                if (els.btnOpenSettingsFromSidebar) {
                    els.btnOpenSettingsFromSidebar.addEventListener('click', () => {
                        els.settingsModal.classList.remove('hidden');
                        // Switch to presets tab
                        els.modalTabPresets.click();
                        updateConfigUI();
                        editingPresetName = null;
                        if (currentModule === 'instruction') {
                            currentPresetType = 'instruction';
                        } else if (currentModule === 'image-reverse') {
                            currentPresetType = 'image-reverse';
                        } else if (currentModule === 'instruction-reverse') {
                            currentPresetType = 'instruction-reverse';
                        } else if (currentModule === 'prompt-helper') {
                            currentPresetType = 'prompt-helper';
                        } else {
                            currentPresetType = 'instruction'; // é»˜è®¤ä½¿ç”¨æŒ‡ä»¤ä¼˜åŒ–
                        }
                        updatePresetToggleUI();
                        renderPresets();
                        updateCurrentPresetDisplay();
                    });
                }
                els.btnCloseSettings.addEventListener('click', () => els.settingsModal.classList.add('hidden'));

                // Modal Sidebar Tabs
                els.modalTabApi.addEventListener('click', () => {
                    els.modalTabApi.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-50 text-indigo-700 font-bold transition-all border border-indigo-100 shadow-sm';
                    els.modalTabPresets.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition-all border border-transparent hover:border-slate-200';
                    els.modalPanelApi.classList.remove('hidden');
                    els.modalPanelPresets.classList.add('hidden');
                });
                els.modalTabPresets.addEventListener('click', () => {
                    els.modalTabPresets.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-50 text-indigo-700 font-bold transition-all border border-indigo-100 shadow-sm';
                    els.modalTabApi.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition-all border border-transparent hover:border-slate-200';
                    editingPresetName = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€
                    els.modalPanelPresets.classList.remove('hidden');
                    els.modalPanelApi.classList.add('hidden');
                    renderPresets(); // é‡æ–°æ¸²æŸ“ï¼Œç¡®ä¿åªæ˜¾ç¤ºå½“å‰ç±»å‹çš„é¢„è®¾
                    applyDefaultPresetSelection();
                    updateCurrentPresetDisplay();
                });

                // Preset Sub-tabs - åˆ‡æ¢æŒ‡ä»¤ç±»å‹æ—¶ï¼Œåªæ˜¾ç¤ºå½“å‰ç±»å‹çš„é¢„è®¾
                if (els.btnTogglePresetPrompt) {
                    els.btnTogglePresetPrompt.addEventListener('click', () => {
                        currentPresetType = 'prompt';
                        editingPresetName = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€ï¼Œç¡®ä¿åªæ˜¾ç¤ºå½“å‰ç±»å‹çš„é¢„è®¾
                        updatePresetToggleUI();
                        resetPresetForm();
                        renderPresets(); // é‡æ–°æ¸²æŸ“ï¼Œåªæ˜¾ç¤º prompt ç±»å‹çš„é¢„è®¾
                        applyDefaultPresetSelection();
                        updateCurrentPresetDisplay();
                    });
                }
                if (els.btnTogglePresetPromptHelper) {
                    els.btnTogglePresetPromptHelper.addEventListener('click', () => {
                        currentPresetType = 'prompt-helper';
                        editingPresetName = null;
                        updatePresetToggleUI();
                        resetPresetForm();
                        renderPresets();
                        applyDefaultPresetSelection();
                        updateCurrentPresetDisplay();
                    });
                }
                els.btnTogglePresetInstruction.addEventListener('click', () => {
                    currentPresetType = 'instruction';
                    editingPresetName = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€ï¼Œç¡®ä¿åªæ˜¾ç¤ºå½“å‰ç±»å‹çš„é¢„è®¾
                    updatePresetToggleUI();
                    resetPresetForm();
                    renderPresets(); // é‡æ–°æ¸²æŸ“ï¼Œåªæ˜¾ç¤º instruction ç±»å‹çš„é¢„è®¾
                    applyDefaultPresetSelection();
                    updateCurrentPresetDisplay();
                });
                els.btnTogglePresetImageReverse.addEventListener('click', () => {
                    currentPresetType = 'image-reverse';
                    editingPresetName = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€ï¼Œç¡®ä¿åªæ˜¾ç¤ºå½“å‰ç±»å‹çš„é¢„è®¾
                    updatePresetToggleUI();
                    resetPresetForm();
                    renderPresets(); // é‡æ–°æ¸²æŸ“ï¼Œåªæ˜¾ç¤º image-reverse ç±»å‹çš„é¢„è®¾
                    applyDefaultPresetSelection();
                    updateCurrentPresetDisplay();
                });
                if (els.btnTogglePresetInstructionReverse) {
                    els.btnTogglePresetInstructionReverse.addEventListener('click', () => {
                        currentPresetType = 'instruction-reverse';
                        editingPresetName = null; // æ¸…é™¤ç¼–è¾‘çŠ¶æ€ï¼Œç¡®ä¿åªæ˜¾ç¤ºå½“å‰ç±»å‹çš„é¢„è®¾
                        updatePresetToggleUI();
                        resetPresetForm();
                        renderPresets(); // é‡æ–°æ¸²æŸ“ï¼Œåªæ˜¾ç¤º instruction-reverse ç±»å‹çš„é¢„è®¾
                        applyDefaultPresetSelection();
                        updateCurrentPresetDisplay();
                    });
                }

                // Save All Config (ç»Ÿä¸€ä¿å­˜æŒ‰é’®)
                if (els.btnSaveAllConfig) {
                    els.btnSaveAllConfig.addEventListener('click', () => {
                        // ä¿å­˜ API é…ç½®
                        appConfig.apiKey = els.inputApiKey.value.trim();
                        appConfig.baseURL = els.selectBaseUrl.value;
                        appConfig.model = els.selectModel.value;

                        // ä¿å­˜ CV é…ç½®
                        appConfig.cvAK = els.inputCvAk.value.trim();
                        appConfig.cvSK = els.inputCvSk.value.trim();

                        // éªŒè¯ API é…ç½®
                        if (!appConfig.apiKey) {
                            showToast('è¯·è¾“å…¥ API å¯†é’¥', 'error');
                            els.inputApiKey.focus();
                            return;
                        }

                        // ä¿å­˜é…ç½®
                        saveConfig();

                        // è§†è§‰åé¦ˆ
                        const btn = els.btnSaveAllConfig;
                        const originalHTML = btn.innerHTML;
                        btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> å·²ä¿å­˜';
                        btn.classList.add('bg-green-600', 'hover:bg-green-700');
                        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                        scheduleIconsUpdate();

                        setTimeout(() => {
                            btn.innerHTML = originalHTML;
                            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                            scheduleIconsUpdate();
                        }, 2000);

                        showToast('é…ç½®å·²ä¿å­˜', 'success');
                    });
                }

                els.btnToggleKey.addEventListener('click', () => {
                    const type = els.inputApiKey.type === 'password' ? 'text' : 'password';
                    els.inputApiKey.type = type;
                    els.btnToggleKey.innerHTML = `<i data-lucide="${type === 'password' ? 'eye' : 'eye-off'}" class="w-4 h-4"></i>`;
                    scheduleIconsUpdate();
                });

                // å½“ baseURL æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨
                els.selectBaseUrl.addEventListener('change', (e) => {
                    const baseURL = e.target.value;
                    const modelSelect = els.selectModel;
                    const currentModel = modelSelect.value;

                    // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    modelSelect.innerHTML = '';

                    if (baseURL.includes('google') || baseURL.includes('googleapis.com')) {
                        // Gemini æ¨¡å‹
                        const geminiModels = [
                            { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash (å…è´¹/å¿«)' },
                            { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro (æ›´å¼º)' },
                            { value: 'gemini-2.0-flash-exp', label: 'Gemini 2.0 Flash (å®éªŒæ€§)' }
                        ];
                        geminiModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.value;
                            option.textContent = model.label;
                            if (model.value === currentModel) option.selected = true;
                            modelSelect.appendChild(option);
                        });
                        if (!geminiModels.find(m => m.value === currentModel)) {
                            modelSelect.value = 'gemini-1.5-flash';
                        }
                    } else if (baseURL.includes('siliconflow')) {
                        // SiliconFlow æ¨¡å‹
                        const sfModels = [
                            { value: 'Qwen/Qwen2-VL-72B-Instruct', label: 'Qwen2-VL 72B (å¼ºå¤§)' },
                            { value: 'Qwen/Qwen2-VL-7B-Instruct', label: 'Qwen2-VL 7B (å…è´¹å±‚)' },
                            { value: 'THUDM/cogview-3-plus', label: 'CogView-3 Plus' },
                            { value: 'deepseek-ai/DeepSeek-V3', label: 'DeepSeek V3' }
                        ];
                        sfModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.value;
                            option.textContent = model.label;
                            if (model.value === currentModel) option.selected = true;
                            modelSelect.appendChild(option);
                        });
                        if (!sfModels.find(m => m.value === currentModel)) {
                            modelSelect.value = 'Qwen/Qwen2-VL-72B-Instruct';
                        }
                    } else if (baseURL.includes('openai') || baseURL.includes('api.openai.com')) {
                        // OpenAI æ¨¡å‹
                        const openAIModels = [
                            { value: 'gpt-4o', label: 'GPT-4o (æ”¯æŒè§†è§‰)' },
                            { value: 'gpt-4-turbo', label: 'GPT-4 Turbo (æ”¯æŒè§†è§‰)' },
                            { value: 'gpt-4-vision-preview', label: 'GPT-4 Vision Preview' },
                            { value: 'gpt-4o-mini', label: 'GPT-4o Mini (æ”¯æŒè§†è§‰)' },
                            { value: 'gpt-4', label: 'GPT-4' },
                            { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' }
                        ];
                        openAIModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.value;
                            option.textContent = model.label;
                            if (model.value === currentModel) {
                                option.selected = true;
                            }
                            modelSelect.appendChild(option);
                        });
                        if (!openAIModels.find(m => m.value === currentModel)) {
                            modelSelect.value = 'gpt-4o';
                        }
                    } else if (baseURL.includes('deepseek')) {
                        // Deepseek æ¨¡å‹
                        const deepseekModels = [
                            { value: 'deepseek-chat', label: 'deepseek-chat' },
                            { value: 'deepseek-coder', label: 'deepseek-coder' }
                        ];
                        deepseekModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.value;
                            option.textContent = model.label;
                            if (model.value === currentModel) {
                                option.selected = true;
                            }
                            modelSelect.appendChild(option);
                        });
                        if (!deepseekModels.find(m => m.value === currentModel)) {
                            modelSelect.value = 'deepseek-chat';
                        }
                    } else if (baseURL.includes('t8star')) {
                        // T8Star æ¨¡å‹ (èšåˆå•†)
                        const t8Models = [
                            { value: 'gpt-4o', label: 'GPT-4o (å¼ºçƒˆæ¨è)' },
                            { value: 'gpt-4o-mini', label: 'GPT-4o Mini (å¿«ä¸”çœ)' },
                            { value: 'claude-3-5-sonnet-20240620', label: 'Claude 3.5 Sonnet' },
                            { value: 'doubao-pro-32k', label: 'è±†åŒ… Pro 32k' },
                            { value: 'doubao-pro-128k', label: 'è±†åŒ… Pro 128k' },
                            { value: 'deepseek-chat', label: 'DeepSeek Chat (V3)' },
                            { value: 'deepseek-coder', label: 'DeepSeek Coder' },
                            { value: 'qwen-vl-max', label: 'é€šä¹‰åƒé—® VL Max' }
                        ];
                        t8Models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.value;
                            option.textContent = model.label;
                            if (model.value === currentModel) option.selected = true;
                            modelSelect.appendChild(option);
                        });
                        if (!t8Models.find(m => m.value === currentModel)) {
                            modelSelect.value = 'gpt-4o';
                        }
                    } else {
                        // è±†åŒ…æ¨¡å‹
                        const doubaoModels = [
                            { value: '4a0f0df9-0108-4585-b794-cadf6b52cc60', label: 'Doubao-Vision-Reverse (API)' },
                            { value: 'ep-20251030180013-p4bww', label: 'Doubao-Pro' }
                        ];
                        doubaoModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.value;
                            option.textContent = model.label;
                            if (model.value === currentModel) {
                                option.selected = true;
                            }
                            modelSelect.appendChild(option);
                        });
                        if (!doubaoModels.find(m => m.value === currentModel)) {
                            modelSelect.value = 'ep-20251030180013-p4bww';
                        }
                    }
                });

                // App Tabs Logic
                els.tabInstruction.addEventListener('click', () => switchTab('instruction'));
                els.tabImageReverse.addEventListener('click', () => switchTab('image-reverse'));
                els.tabInstructionReverse.addEventListener('click', () => switchTab('instruction-reverse'));
                if (els.tabPromptHelper) els.tabPromptHelper.addEventListener('click', () => switchTab('prompt-helper'));
                if (els.tabPromptHelper) els.tabPromptHelper.addEventListener('click', () => switchTab('prompt-helper'));

                // Processor Input
                els.inputPrompt.addEventListener('input', (e) => {
                    els.charCount.textContent = `${e.target.value.length} å­—ç¬¦`;
                    els.btnOptimize.disabled = !e.target.value.trim();
                });


                els.btnClearInput.addEventListener('click', () => {
                    els.inputPrompt.value = '';
                    els.charCount.textContent = '0 å­—ç¬¦';
                    els.btnOptimize.disabled = true;
                    if (els.outputPrompt) els.outputPrompt.value = '';
                    if (els.outputCharCount) els.outputCharCount.textContent = '0 å­—ç¬¦';
                    if (els.reasoningCard) els.reasoningCard.classList.add('hidden');
                    els.inputPrompt.focus();
                });

                // Copy Result
                if (els.btnCopy) els.btnCopy.addEventListener('click', () => {
                    const text = els.outputPrompt.value;
                    if (!text) return;
                    navigator.clipboard.writeText(text);
                    els.copyText.textContent = 'å·²å¤åˆ¶';
                    setTimeout(() => { els.copyText.textContent = 'å¤åˆ¶'; }, 2000);
                });
                if (els.btnCopyReasoning) els.btnCopyReasoning.addEventListener('click', () => {
                    const text = (els.reasoningContent && els.reasoningContent.textContent) || '';
                    if (!text.trim()) return;
                    navigator.clipboard.writeText(text);
                    showToast('å·²å¤åˆ¶', 'success');
                });

                // Optimize Action
                if (els.btnOptimize) els.btnOptimize.addEventListener('click', handleOptimize);

                // Prompt Helper module
                if (els.inputPromptHelper) {
                    els.inputPromptHelper.addEventListener('input', (e) => {
                        if (els.charCountHelper) els.charCountHelper.textContent = `${e.target.value.length} å­—ç¬¦`;
                        if (els.btnOptimizeHelper) els.btnOptimizeHelper.disabled = !e.target.value.trim();
                    });
                }
                if (els.btnClearInputHelper) {
                    els.btnClearInputHelper.addEventListener('click', () => {
                        if (els.inputPromptHelper) els.inputPromptHelper.value = '';
                        if (els.charCountHelper) els.charCountHelper.textContent = '0 å­—ç¬¦';
                        if (els.btnOptimizeHelper) els.btnOptimizeHelper.disabled = true;
                        if (els.outputPromptHelper) els.outputPromptHelper.value = '';
                        if (els.outputCharCountHelper) els.outputCharCountHelper.textContent = '0 å­—ç¬¦';
                        if (els.reasoningCardHelper) els.reasoningCardHelper.classList.add('hidden');
                        if (els.inputPromptHelper) els.inputPromptHelper.focus();
                    });
                }
                if (els.btnCopyHelper) {
                    els.btnCopyHelper.addEventListener('click', () => {
                        if (!els.outputPromptHelper) return;
                        const text = els.outputPromptHelper.value;
                        if (!text) return;
                        navigator.clipboard.writeText(text);
                        if (els.copyTextHelper) {
                            els.copyTextHelper.textContent = 'å·²å¤åˆ¶';
                            setTimeout(() => { els.copyTextHelper.textContent = 'å¤åˆ¶'; }, 2000);
                        }
                    });
                }
                if (els.btnCopyReasoningHelper) {
                    els.btnCopyReasoningHelper.addEventListener('click', () => {
                        const text = (els.reasoningContentHelper && els.reasoningContentHelper.textContent) || '';
                        if (!text.trim()) return;
                        navigator.clipboard.writeText(text);
                        showToast('å·²å¤åˆ¶', 'success');
                    });
                }
                if (els.btnOptimizeHelper) {
                    els.btnOptimizeHelper.addEventListener('click', handlePromptHelperOptimize);
                }

                // Image Reverse Module Event Listeners
                if (els.imageDropzone) {
                    els.imageDropzone.addEventListener('click', () => els.inputImage.click());
                    els.imageDropzone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        els.imageDropzone.classList.add('border-purple-500', 'bg-purple-50');
                    });
                    els.imageDropzone.addEventListener('dragleave', () => {
                        els.imageDropzone.classList.remove('border-purple-500', 'bg-purple-50');
                    });
                    els.imageDropzone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        els.imageDropzone.classList.remove('border-purple-500', 'bg-purple-50');
                        if (e.dataTransfer.files.length > 0) {
                            handleImageUpload(e.dataTransfer.files[0]);
                        }
                    });
                }

                if (els.inputImage) {
                    els.inputImage.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            handleImageUpload(e.target.files[0]);
                        }
                    });
                }

                if (els.btnClearImage) {
                    els.btnClearImage.addEventListener('click', () => {
                        uploadedImageBase64 = null;
                        els.imagePreviewContainer.classList.add('hidden');
                        els.imageDropzone.classList.remove('hidden');
                        els.btnClearImage.classList.add('hidden');
                        els.btnReverse.disabled = true;
                        els.outputImagePrompt.classList.add('hidden');
                        els.outputPlaceholderImage.classList.remove('hidden');
                        els.outputIndicatorImage.classList.add('hidden');
                        els.btnCopyImage.disabled = true;
                    });
                }

                if (els.btnReverse) {
                    els.btnReverse.addEventListener('click', handleImageReverse);
                }

                if (els.btnCopyImage) {
                    els.btnCopyImage.addEventListener('click', () => {
                        navigator.clipboard.writeText(els.outputImagePrompt.value);
                        els.copyTextImage.textContent = 'å·²å¤åˆ¶';
                        setTimeout(() => els.copyTextImage.textContent = 'å¤åˆ¶', 2000);
                    });
                }

                if (els.btnOpenSettingsFromSidebarImage) {
                    els.btnOpenSettingsFromSidebarImage.addEventListener('click', () => {
                        els.settingsModal.classList.remove('hidden');
                        els.modalTabPresets.click();
                        updateConfigUI();
                        currentPresetType = 'image-reverse';
                        updatePresetToggleUI();
                        renderPresets();
                        updateCurrentPresetDisplay();
                    });
                }

                if (els.btnOpenSettingsFromSidebarHelper) {
                    els.btnOpenSettingsFromSidebarHelper.addEventListener('click', () => {
                        els.settingsModal.classList.remove('hidden');
                        els.modalTabPresets.click();
                        updateConfigUI();
                        currentPresetType = 'prompt-helper';
                        updatePresetToggleUI();
                        renderPresets();
                        updateCurrentPresetDisplay();
                    });
                }

                // Instruction Reverse Module Event Listeners
                if (els.imageDropzone1) {
                    els.imageDropzone1.addEventListener('click', () => els.inputImage1.click());
                    els.imageDropzone1.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        els.imageDropzone1.classList.add('border-blue-500', 'bg-blue-50');
                    });
                    els.imageDropzone1.addEventListener('dragleave', () => {
                        els.imageDropzone1.classList.remove('border-blue-500', 'bg-blue-50');
                    });
                    els.imageDropzone1.addEventListener('drop', (e) => {
                        e.preventDefault();
                        els.imageDropzone1.classList.remove('border-blue-500', 'bg-blue-50');
                        if (e.dataTransfer.files.length > 0) {
                            handleImageUpload1(e.dataTransfer.files[0]);
                        }
                    });
                }

                if (els.inputImage1) {
                    els.inputImage1.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            handleImageUpload1(e.target.files[0]);
                        }
                    });
                }

                if (els.imageDropzone2) {
                    els.imageDropzone2.addEventListener('click', () => els.inputImage2.click());
                    els.imageDropzone2.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        els.imageDropzone2.classList.add('border-teal-500', 'bg-teal-50');
                    });
                    els.imageDropzone2.addEventListener('dragleave', () => {
                        els.imageDropzone2.classList.remove('border-teal-500', 'bg-teal-50');
                    });
                    els.imageDropzone2.addEventListener('drop', (e) => {
                        e.preventDefault();
                        els.imageDropzone2.classList.remove('border-teal-500', 'bg-teal-50');
                        if (e.dataTransfer.files.length > 0) {
                            handleImageUpload2(e.dataTransfer.files[0]);
                        }
                    });
                }

                if (els.inputImage2) {
                    els.inputImage2.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            handleImageUpload2(e.target.files[0]);
                        }
                    });
                }

                if (els.btnClearImage1) {
                    els.btnClearImage1.addEventListener('click', () => {
                        uploadedImage1Base64 = null;
                        els.imagePreviewContainer1.classList.add('hidden');
                        els.imageDropzone1.classList.remove('hidden');
                        els.btnClearImage1.classList.add('hidden');
                        updateOptimizeButtonState();
                    });
                }

                if (els.btnClearImage2) {
                    els.btnClearImage2.addEventListener('click', () => {
                        uploadedImage2Base64 = null;
                        els.imagePreviewContainer2.classList.add('hidden');
                        els.imageDropzone2.classList.remove('hidden');
                        els.btnClearImage2.classList.add('hidden');
                        updateOptimizeButtonState();
                    });
                }

                if (els.btnOptimizeInstructionReverse) {
                    els.btnOptimizeInstructionReverse.addEventListener('click', handleInstructionReverse);
                }

                if (els.inputInstructionReverseText) {
                    els.inputInstructionReverseText.addEventListener('input', (e) => {
                        if (els.instructionReverseCharCount) {
                            els.instructionReverseCharCount.textContent = `${e.target.value.length} å­—ç¬¦`;
                        }
                        updateOptimizeButtonState();
                    });
                }

                if (els.btnCopyInstructionReverse) {
                    els.btnCopyInstructionReverse.addEventListener('click', () => {
                        navigator.clipboard.writeText(els.outputInstructionReverse.value);
                        els.copyTextInstructionReverse.textContent = 'å·²å¤åˆ¶';
                        setTimeout(() => els.copyTextInstructionReverse.textContent = 'å¤åˆ¶', 2000);
                    });
                }

                if (els.btnOpenSettingsFromSidebarInstructionReverse) {
                    els.btnOpenSettingsFromSidebarInstructionReverse.addEventListener('click', () => {
                        els.settingsModal.classList.remove('hidden');
                        els.modalTabPresets.click();
                        updateConfigUI();
                        currentPresetType = 'instruction-reverse';
                        updatePresetToggleUI();
                        renderPresets();
                        updateCurrentPresetDisplay();
                    });
                }

                // Presets Logic (In Modal)
                // æ–°å»ºé¢„è®¾
                if (els.btnNewPreset) {
                    els.btnNewPreset.addEventListener('click', () => {
                        editingPresetName = '__new__';
                        renderPresets();
                    });
                }

                if (els.btnExportPresets) {
                    els.btnExportPresets.addEventListener('click', () => {
                        const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                            (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                                instructionPresets;
                        const blob = new Blob([JSON.stringify(presets, null, 2)], { type: 'application/json' });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `presets_${currentPresetType}.json`;
                        a.click();
                        URL.revokeObjectURL(a.href);
                        showToast('é¢„è®¾å·²å¯¼å‡º', 'success');
                    });
                }

                if (els.btnImportPresets && els.inputImportPresets) {
                    els.btnImportPresets.addEventListener('click', () => els.inputImportPresets.click());
                    els.inputImportPresets.addEventListener('change', (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            try {
                                const data = JSON.parse(evt.target.result);
                                if (!data || typeof data !== 'object' || Array.isArray(data)) {
                                    showToast('å¯¼å…¥æ ¼å¼ä¸æ­£ç¡®', 'error');
                                    return;
                                }
                                const presetsRef = (currentPresetType === 'image-reverse') ? imageReversePresets :
                                    (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                                        instructionPresets;
                                Object.keys(data).forEach(k => {
                                    const v = data[k];
                                    if (typeof v === 'string') presetsRef[k] = v;
                                });
                                savePresetsData();
                                renderPresets();
                                updateCurrentPresetDisplay();
                                showToast('é¢„è®¾å·²å¯¼å…¥', 'success');
                            } catch (err) {
                                showToast('å¯¼å…¥å¤±è´¥', 'error');
                            } finally {
                                e.target.value = '';
                            }
                        };
                        reader.readAsText(file);
                    });
                }

                // å–æ¶ˆç¼–è¾‘
                if (els.btnCancelEdit) {
                    els.btnCancelEdit.addEventListener('click', () => {
                        resetPresetForm();
                    });
                }

                // å…¼å®¹æ—§çš„ select å…ƒç´ 
                if (els.selectPreset) {
                    els.selectPreset.addEventListener('change', (e) => {
                        const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                            (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                                instructionPresets;
                        const name = e.target.value;
                        if (name && presets[name]) {
                            editPreset(name);
                        } else {
                            resetPresetForm();
                        }
                    });
                }

                // è¾“å…¥ç›‘å¬
                if (els.inputSystemPrompt) {
                    els.inputSystemPrompt.addEventListener('input', () => {
                        updateSaveButtonState();
                        updatePresetCharCount();
                    });
                }
                if (els.inputPresetName) {
                    els.inputPresetName.addEventListener('input', updateSaveButtonState);
                }
                if (els.btnSavePreset) {
                    els.btnSavePreset.addEventListener('click', () => {
                        const presets = (currentPresetType === 'image-reverse') ? imageReversePresets :
                            (currentPresetType === 'instruction-reverse') ? instructionReversePresets :
                                (currentPresetType === 'prompt-helper') ? promptHelperPresets :
                                    (currentPresetType === 'instruction') ? instructionPresets : promptPresets;

                        const name = els.inputPresetName ? els.inputPresetName.value.trim() : '';
                        const content = els.inputSystemPrompt ? els.inputSystemPrompt.value.trim() : '';

                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç¼–è¾‘ç°æœ‰é¢„è®¾
                        const isEditing = els.btnDeletePreset && !els.btnDeletePreset.classList.contains('hidden');
                        const oldName = isEditing && els.inputPresetName ? els.inputPresetName.value.trim() : null;

                        if (!name) {
                            showToast('è¯·è¾“å…¥é¢„è®¾åç§°', 'error');
                            if (els.inputPresetName) els.inputPresetName.focus();
                            return;
                        }
                        if (!content) {
                            showToast('è¯·è¾“å…¥ç³»ç»Ÿæç¤ºè¯å†…å®¹', 'error');
                            if (els.inputSystemPrompt) els.inputSystemPrompt.focus();
                            return;
                        }

                        // å¦‚æœæ˜¯ç¼–è¾‘ä¸”åç§°æ”¹å˜ï¼Œéœ€è¦åˆ é™¤æ—§åç§°
                        if (isEditing && oldName && oldName !== name && presets[oldName]) {
                            delete presets[oldName];
                            // å¦‚æœæ—§åç§°æ˜¯æ´»åŠ¨é¢„è®¾ï¼Œæ›´æ–°æ´»åŠ¨é¢„è®¾
                            if (activePresets[currentPresetType] === oldName) {
                                activePresets[currentPresetType] = name;
                            }
                        }

                        // ä¿å­˜é¢„è®¾
                        presets[name] = content;
                        savePresetsData();

                        // é‡æ–°æ¸²æŸ“é¢„è®¾åˆ—è¡¨
                        renderPresets();

                        // æ›´æ–°è¡¨å•çŠ¶æ€ä¸ºç¼–è¾‘æ¨¡å¼
                        if (els.inputPresetName) els.inputPresetName.value = name;
                        if (els.inputSystemPrompt) els.inputSystemPrompt.value = content;
                        if (els.presetNameContainer) els.presetNameContainer.classList.add('hidden');
                        if (els.btnDeletePreset) els.btnDeletePreset.classList.remove('hidden');
                        if (els.btnCancelEdit) els.btnCancelEdit.classList.remove('hidden');
                        els.editorTitle.textContent = `ç¼–è¾‘é¢„è®¾: ${name}`;
                        els.btnSaveText.textContent = 'ä¿å­˜æ›´æ”¹';

                        updateSaveButtonState();
                        updateCurrentPresetDisplay();
                        showToast(`é¢„è®¾ "${name}" å·²ä¿å­˜`, 'success');

                        // é«˜äº®æ˜¾ç¤ºä¿å­˜çš„é¢„è®¾å¡ç‰‡
                        if (els.presetsListContainer) {
                            setTimeout(() => {
                                const savedCard = els.presetsListContainer.querySelector(`[data-preset-name="${name}"]`);
                                if (savedCard) {
                                    savedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                    savedCard.classList.add('ring-2', 'ring-indigo-500');
                                    setTimeout(() => {
                                        savedCard.classList.remove('ring-2', 'ring-indigo-500');
                                    }, 2000);
                                }
                            }, 100);
                        }
                    });
                }
                if (els.btnDeletePreset) {
                    els.btnDeletePreset.addEventListener('click', () => {
                        const name = els.inputPresetName ? els.inputPresetName.value.trim() : '';
                        if (!name) return;
                        deletePreset(name);
                    });
                }

                // Delete Confirmation Modal Events
                if (els.btnCancelDelete) els.btnCancelDelete.addEventListener('click', hideDeleteConfirmation);
                if (els.btnConfirmDelete) els.btnConfirmDelete.addEventListener('click', executeDeletePreset);
                // Click outside to close
                if (els.deleteModal) {
                    els.deleteModal.addEventListener('click', (e) => {
                        if (e.target === els.deleteModal) hideDeleteConfirmation();
                    });
                }
                document.addEventListener('keydown', (e) => {
                    if (!els.deleteModal || els.deleteModal.classList.contains('hidden')) return;
                    if (e.key === 'Escape') hideDeleteConfirmation();
                    if (e.key === 'Enter') executeDeletePreset();
                });
            }

            function updatePresetToggleUI() {
                if (currentPresetType === 'instruction') {
                    els.btnTogglePresetInstruction.className = 'px-5 py-2 rounded-xl text-sm font-bold bg-white shadow-sm text-indigo-600 border border-slate-100 transition-all';
                    els.btnTogglePresetImageReverse.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    if (els.btnTogglePresetInstructionReverse) {
                        els.btnTogglePresetInstructionReverse.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    }
                    const btnPH = document.getElementById('btn-toggle-preset-prompt-helper');
                    if (btnPH) btnPH.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                } else if (currentPresetType === 'instruction-reverse') {
                    if (els.btnTogglePresetInstructionReverse) {
                        els.btnTogglePresetInstructionReverse.className = 'px-5 py-2 rounded-xl text-sm font-bold bg-white shadow-sm text-indigo-600 border border-slate-100 transition-all';
                    }
                    els.btnTogglePresetInstruction.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    els.btnTogglePresetImageReverse.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    const btnPH = document.getElementById('btn-toggle-preset-prompt-helper');
                    if (btnPH) btnPH.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                } else if (currentPresetType === 'prompt-helper') {
                    const btnPH = document.getElementById('btn-toggle-preset-prompt-helper');
                    if (btnPH) btnPH.className = 'px-5 py-2 rounded-xl text-sm font-bold bg-white shadow-sm text-indigo-600 border border-slate-100 transition-all';
                    els.btnTogglePresetInstruction.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    els.btnTogglePresetImageReverse.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    if (els.btnTogglePresetInstructionReverse) {
                        els.btnTogglePresetInstructionReverse.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    }
                } else {
                    els.btnTogglePresetImageReverse.className = 'px-5 py-2 rounded-xl text-sm font-bold bg-white shadow-sm text-indigo-600 border border-slate-100 transition-all';
                    els.btnTogglePresetInstruction.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    if (els.btnTogglePresetInstructionReverse) {
                        els.btnTogglePresetInstructionReverse.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                    }
                    const btnPH = document.getElementById('btn-toggle-preset-prompt-helper');
                    if (btnPH) btnPH.className = 'px-5 py-2 rounded-xl text-sm font-medium text-slate-500 hover:text-slate-700 transition-all';
                }
            }

            // Shared Logic
            function saveSharedViewState(module) {
                if (module !== 'prompt' && module !== 'instruction') return;
                const state = sharedViewState[module];
                if (!state) return;
                if (els.inputPrompt) state.input = els.inputPrompt.value;
                if (els.outputPrompt) {
                    state.output = els.outputPrompt.value;
                    state.outputVisible = !els.outputPrompt.classList.contains('hidden');
                }
                if (els.outputIndicator) state.indicatorVisible = !els.outputIndicator.classList.contains('hidden');
                if (els.btnOptimize) state.optimizeEnabled = !els.btnOptimize.disabled;
                if (els.btnCopy) state.copyEnabled = !els.btnCopy.disabled;
                if (els.copyText) state.copyText = els.copyText.textContent || 'å¤åˆ¶';
                if (els.charCount) state.charCount = els.charCount.textContent || '0 å­—ç¬¦';
                if (els.reasoningContent) {
                    state.reasoning = els.reasoningContent.textContent;
                    state.reasoningVisible = !els.reasoningCard.classList.contains('hidden');
                }
            }

            function restoreSharedViewState(module) {
                if (module !== 'prompt' && module !== 'instruction') return;
                const state = sharedViewState[module];
                if (!state) return;
                if (els.inputPrompt) els.inputPrompt.value = state.input;
                if (els.outputPrompt) {
                    els.outputPrompt.value = state.output;
                    if (state.outputVisible) {
                        els.outputPrompt.classList.remove('hidden');
                        if (els.outputPlaceholder) els.outputPlaceholder.classList.add('hidden');
                    } else {
                        els.outputPrompt.classList.add('hidden');
                        if (els.outputPlaceholder) els.outputPlaceholder.classList.remove('hidden');
                    }
                }
                if (els.outputIndicator) {
                    if (state.indicatorVisible) {
                        els.outputIndicator.classList.remove('hidden');
                    } else {
                        els.outputIndicator.classList.add('hidden');
                    }
                }
                if (els.btnOptimize) els.btnOptimize.disabled = !state.optimizeEnabled;
                if (els.btnCopy) els.btnCopy.disabled = !state.copyEnabled;
                if (els.copyText) els.copyText.textContent = state.copyText || 'å¤åˆ¶';
                if (els.charCount) els.charCount.textContent = state.charCount || '0 å­—ç¬¦';
                if (els.reasoningCard && els.reasoningContent) {
                    els.reasoningContent.textContent = state.reasoning || '';
                    if (state.reasoningVisible) {
                        els.reasoningCard.classList.remove('hidden');
                    } else {
                        els.reasoningCard.classList.add('hidden');
                    }
                }
            }

            function parseOptimizationResponse(response) {
                const reasoningMarker = 'ã€ä¼˜åŒ–æ€è·¯ã€‘';
                const resultMarker = 'ã€ä¼˜åŒ–ç»“æœã€‘';

                if (response.includes(reasoningMarker) && response.includes(resultMarker)) {
                    const parts = response.split(resultMarker);
                    const reasoningPart = parts[0].replace(reasoningMarker, '').trim();
                    const resultPart = parts[1].trim();
                    return { reasoning: reasoningPart, result: resultPart };
                }

                // Fallback if markers are missing
                return { reasoning: null, result: response.trim() };
            }

            function isStepPreset(preset) {
                return preset && typeof preset === 'object' && (preset.step1 || preset.step2);
            }

            function getPresetPreviewText(preset) {
                if (typeof preset === 'string') return preset;
                if (isStepPreset(preset)) {
                    const s1 = preset.step1 || '';
                    const s2 = preset.step2 || '';
                    return `${s1}\n${s2}`.trim();
                }
                return String(preset || '');
            }

            function switchTab(module) {
                const prevModule = currentModule;
                // ä¿å­˜å…±äº«è§†å›¾çŠ¶æ€ï¼ˆprompt ä¸ instruction å…±ç”¨è§†å›¾ï¼‰
                saveSharedViewState(prevModule);
                currentModule = module;
                try { localStorage.setItem(CURRENT_MODULE_KEY, module); } catch (e) { }
                const tabs = ['prompt', 'instruction', 'image-reverse', 'instruction-reverse', 'prompt-helper'];
                tabs.forEach(t => {
                    let tabName;
                    if (t === 'image-reverse') {
                        tabName = 'ImageReverse';
                    } else if (t === 'instruction-reverse') {
                        tabName = 'InstructionReverse';
                    } else if (t === 'prompt-helper') {
                        tabName = 'PromptHelper';
                    } else {
                        tabName = t.charAt(0).toUpperCase() + t.slice(1);
                    }
                    const btn = els[`tab${tabName}`];
                    if (btn) {
                        if (t === module) {
                            btn.className = 'tab-active px-6 py-2.5 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center gap-2 border';
                        } else {
                            btn.className = 'tab-inactive px-6 py-2.5 rounded-xl text-sm font-semibold transition-all duration-300 flex items-center gap-2 border';
                        }
                    }
                });

                // Toggle views - ç¡®ä¿åªæ˜¾ç¤ºå½“å‰æ¨¡å—çš„å†…å®¹
                // é¦–å…ˆéšè—æ‰€æœ‰è§†å›¾
                if (els.viewPrompt) {
                    els.viewPrompt.classList.remove('grid');
                    els.viewPrompt.classList.add('hidden');
                }
                if (els.viewPromptHelper) {
                    els.viewPromptHelper.classList.remove('grid');
                    els.viewPromptHelper.classList.add('hidden');
                }
                if (els.viewImageReverse) {
                    els.viewImageReverse.classList.remove('grid');
                    els.viewImageReverse.classList.add('hidden');
                }
                if (els.viewInstructionReverse) {
                    els.viewInstructionReverse.classList.remove('grid');
                    els.viewInstructionReverse.classList.add('hidden');
                }

                // ç„¶ååªæ˜¾ç¤ºå½“å‰æ¨¡å—çš„è§†å›¾
                if (module === 'image-reverse') {
                    if (els.viewImageReverse) {
                        els.viewImageReverse.classList.remove('hidden');
                        els.viewImageReverse.classList.add('grid');
                    }
                } else if (module === 'instruction-reverse') {
                    if (els.viewInstructionReverse) {
                        els.viewInstructionReverse.classList.remove('hidden');
                        els.viewInstructionReverse.classList.add('grid');
                    }
                } else if (module === 'prompt-helper') {
                    if (els.viewPromptHelper) {
                        els.viewPromptHelper.classList.remove('hidden');
                        els.viewPromptHelper.classList.add('grid');
                    }
                } else {
                    // prompt å’Œ instruction å…±äº«åŒä¸€ä¸ªè§†å›¾
                    if (els.viewPrompt) {
                        els.viewPrompt.classList.remove('hidden');
                        els.viewPrompt.classList.add('grid');
                    }

                    // Update workbench icon/text based on tab
                    if (module === 'prompt') {
                        if (els.workbenchTitle) els.workbenchTitle.textContent = 'æç¤ºè¯å¸®å†™å·¥ä½œå°';
                        if (els.workbenchSubtitle) els.workbenchSubtitle.textContent = 'Generate a structured prompt';
                        if (els.workbenchIcon) {
                            els.workbenchIcon.setAttribute('data-lucide', 'sparkles');
                            if (els.workbenchIcon.parentElement) {
                                els.workbenchIcon.parentElement.className = 'w-10 h-10 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm';
                            }
                        }
                        // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
                        if (els.inputPrompt) {
                            els.inputPrompt.placeholder = 'æè¿°ä½ çš„ç›®æ ‡ã€å—ä¼—ä¸æœŸæœ›è¾“å‡ºæ ¼å¼...';
                        }
                    } else if (module === 'instruction') {
                        if (els.workbenchTitle) els.workbenchTitle.textContent = 'æŒ‡ä»¤ä¼˜åŒ–å·¥ä½œå°';
                        if (els.workbenchSubtitle) els.workbenchSubtitle.textContent = 'Fine-tune your instructions';
                        if (els.workbenchIcon) {
                            els.workbenchIcon.setAttribute('data-lucide', 'binary');
                            if (els.workbenchIcon.parentElement) {
                                els.workbenchIcon.parentElement.className = 'w-10 h-10 rounded-xl bg-indigo-50 border border-indigo-100 flex items-center justify-center text-indigo-600 shadow-sm';
                            }
                        }
                        // æ›´æ–°è¾“å…¥æ¡†å ä½ç¬¦
                        if (els.inputPrompt) {
                            els.inputPrompt.placeholder = 'è¾“å…¥éœ€è¦ä¼˜åŒ–çš„æŒ‡ä»¤å†…å®¹...\n\nğŸ’¡ æç¤ºï¼š\nâ€¢ ä½¿ç”¨ BRRE/CRISPE æ¡†æ¶ç»„ç»‡æŒ‡ä»¤\nâ€¢ æ˜ç¡®ä¸Šä¸‹æ–‡ã€è¾“å…¥çº¦æŸå’Œè¾“å‡ºæ ¼å¼\nâ€¢ è®¾å®š AI è§’è‰²ä¸èƒ½åŠ›è¾¹ç•Œ';
                        }
                    }

                    // æ¢å¤å…±äº«è§†å›¾çš„çŠ¶æ€
                    if (module === 'prompt' || module === 'instruction') {
                        restoreSharedViewState(module);
                    }
                }
                scheduleIconsUpdate();
                updateSidebarPreset();
                // åœ¨æ‰€æœ‰è§†å›¾åˆ‡æ¢å®Œæˆåï¼Œæ›´æ–°æç¤ºå†…å®¹ï¼ˆç¡®ä¿ currentModule å·²æ­£ç¡®è®¾ç½®ï¼‰
                updateSidebarTips();
            }

            // Usage Stats Functions
            function getUsageCount() {
                const stored = localStorage.getItem(USAGE_COUNT_KEY);
                return stored ? parseInt(stored, 10) : 0;
            }

            function updateUsageCount() {
                let count = getUsageCount();
                count++;
                localStorage.setItem(USAGE_COUNT_KEY, count.toString());
                if (els.usageCounts) {
                    els.usageCounts.forEach(el => el.textContent = count);
                }
            }

            function initUsageCount() {
                const count = getUsageCount();
                if (els.usageCounts) {
                    els.usageCounts.forEach(el => el.textContent = count);
                }
            }

            function updateSidebarPreset() {
                // Handle image-reverse module separately
                if (currentModule === 'image-reverse') {
                    if (!els.presetNameDisplayImage || !els.presetPreviewImage) {
                        // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨ updateSidebarTips()ï¼Œç”±è°ƒç”¨è€…ç»Ÿä¸€è°ƒç”¨
                        scheduleIconsUpdate();
                        return;
                    }
                    const presets = imageReversePresets;
                    const presetKeys = Object.keys(presets).sort();

                    let activeKey = presetKeys.length > 0 ? presetKeys[0] : null;
                    if (activePresets['image-reverse'] && presets[activePresets['image-reverse']]) {
                        activeKey = activePresets['image-reverse'];
                    }

                    if (activeKey) {
                        els.presetNameDisplayImage.textContent = activeKey;
                        const previewText = presets[activeKey];
                        els.presetPreviewImage.textContent = previewText.length > 100 ? previewText.substring(0, 100) + '...' : previewText;
                    } else {
                        els.presetNameDisplayImage.textContent = 'æš‚æ— é¢„è®¾';
                        els.presetPreviewImage.textContent = 'è¯·åœ¨è®¾ç½®ä¸­åˆ›å»ºé¢„è®¾';
                    }
                } else if (currentModule === 'instruction-reverse') {
                    if (!els.presetNameDisplayInstructionReverse || !els.presetPreviewInstructionReverse) {
                        // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨ updateSidebarTips()ï¼Œç”±è°ƒç”¨è€…ç»Ÿä¸€è°ƒç”¨
                        scheduleIconsUpdate();
                        return;
                    }
                    const presets = instructionReversePresets;
                    const presetKeys = Object.keys(presets).sort();

                    let activeKey = presetKeys.length > 0 ? presetKeys[0] : null;
                    if (activePresets['instruction-reverse'] && presets[activePresets['instruction-reverse']]) {
                        activeKey = activePresets['instruction-reverse'];
                    }

                    if (activeKey) {
                        els.presetNameDisplayInstructionReverse.textContent = activeKey;
                        const previewText = presets[activeKey];
                        els.presetPreviewInstructionReverse.textContent = previewText.length > 100 ? previewText.substring(0, 100) + '...' : previewText;
                    } else {
                        els.presetNameDisplayInstructionReverse.textContent = 'æš‚æ— é¢„è®¾';
                        els.presetPreviewInstructionReverse.textContent = 'è¯·åœ¨è®¾ç½®ä¸­åˆ›å»ºé¢„è®¾';
                    }
                } else if (currentModule === 'prompt-helper') {
                    if (!els.presetNameDisplayHelper || !els.presetPreviewHelper) {
                        scheduleIconsUpdate();
                        return;
                    }
                    const presets = promptHelperPresets;
                    const presetKeys = Object.keys(presets).sort();
                    let activeKey = presetKeys.length > 0 ? presetKeys[0] : null;
                    if (activePresets['prompt-helper'] && presets[activePresets['prompt-helper']]) {
                        activeKey = activePresets['prompt-helper'];
                    }
                    if (activeKey) {
                        els.presetNameDisplayHelper.textContent = activeKey;
                        const previewText = getPresetPreviewText(presets[activeKey]);
                        els.presetPreviewHelper.textContent = previewText.length > 100 ? previewText.substring(0, 100) + '...' : previewText;
                    } else {
                        els.presetNameDisplayHelper.textContent = 'æš‚æ— é¢„è®¾';
                        els.presetPreviewHelper.textContent = 'è¯·åœ¨è®¾ç½®ä¸­åˆ›å»ºé¢„è®¾';
                    }
                } else {
                    if (!els.presetNameDisplay || !els.presetPreview) {
                        // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨ updateSidebarTips()ï¼Œç”±è°ƒç”¨è€…ç»Ÿä¸€è°ƒç”¨
                        scheduleIconsUpdate();
                        return;
                    }

                    // æŒ‡ä»¤ä¼˜åŒ–ä½¿ç”¨ instructionPresets
                    const presets = instructionPresets;
                    const presetKeys = Object.keys(presets).sort();

                    let activeKey = presetKeys.length > 0 ? presetKeys[0] : null;
                    const storedActive = activePresets[currentModule];
                    if (storedActive && presets[storedActive]) {
                        activeKey = storedActive;
                    }

                    if (activeKey) {
                        els.presetNameDisplay.textContent = activeKey;
                        const previewText = getPresetPreviewText(presets[activeKey]);
                        els.presetPreview.textContent = previewText.length > 100 ? previewText.substring(0, 100) + '...' : previewText;
                    } else {
                        els.presetNameDisplay.textContent = 'æš‚æ— é¢„è®¾';
                        els.presetPreview.textContent = 'è¯·åœ¨è®¾ç½®ä¸­åˆ›å»ºé¢„è®¾';
                    }
                }

                // æ³¨æ„ï¼šä¸åœ¨è¿™é‡Œè°ƒç”¨ updateSidebarTips()ï¼Œç”±è°ƒç”¨è€…ç»Ÿä¸€è°ƒç”¨
                // ç¡®ä¿å›¾æ ‡æ­£ç¡®æ¸²æŸ“
                scheduleIconsUpdate();
            }

            function updateSidebarTips() {
                let tipsEl;
                if (currentModule === 'image-reverse') {
                    tipsEl = els.tipsContentImage;
                } else if (currentModule === 'instruction-reverse') {
                    tipsEl = els.tipsContentInstructionReverse;
                } else if (currentModule === 'prompt-helper') {
                    tipsEl = els.tipsContentHelper;
                } else {
                    tipsEl = els.tipsContent;
                }

                if (!tipsEl) {
                    console.warn('Tips element not found for module:', currentModule);
                    return;
                }

                // æ ¹æ® currentModule ä¸¥æ ¼åŒºåˆ†æç¤ºå†…å®¹
                let tips, title;

                if (currentModule === 'image-reverse') {
                    tips = [
                        'ä¸Šä¼ æ¸…æ™°ã€é«˜è´¨é‡çš„å›¾ç‰‡ä»¥è·å¾—æ›´å¥½çš„æè¿°',
                        'ä¸åŒçš„é¢„è®¾ä¼šäº§ç”Ÿä¸åŒé£æ ¼çš„æè¿°ç»“æœ',
                        'åæ¨ç»“æœå¯ä»¥ç›´æ¥ç”¨äº AI ç»˜å›¾å·¥å…·',
                        'æ”¯æŒ JPGã€PNGã€WebP ç­‰å¸¸è§å›¾ç‰‡æ ¼å¼',
                        'åœ¨è®¾ç½®ä¸­å¯ä»¥è‡ªå®šä¹‰åæ¨ç­–ç•¥é¢„è®¾'
                    ];
                    title = 'ä¼˜åŒ–æŠ€å·§';
                } else if (currentModule === 'instruction-reverse') {
                    tips = [
                        'ä¸Šä¼ ä¸¤å¼ æ¸…æ™°çš„å›¾ç‰‡è¿›è¡Œå¯¹æ¯”åˆ†æ',
                        'å›¾ç‰‡1å’Œå›¾ç‰‡2éƒ½éœ€è¦ä¸Šä¼ æ‰èƒ½å¼€å§‹ä¼˜åŒ–',
                        'å¡«å†™ç”¨æˆ·è¾“å…¥ä½œä¸ºç›®æ ‡æˆ–çº¦æŸï¼Œæå‡æŒ‡ä»¤è´´åˆåº¦',
                        'æ”¯æŒ JPGã€PNGã€WebP ç­‰å¸¸è§å›¾ç‰‡æ ¼å¼',
                        'åœ¨è®¾ç½®ä¸­å¯ä»¥è‡ªå®šä¹‰æŒ‡ä»¤åæ¨ç­–ç•¥é¢„è®¾'
                    ];
                    title = 'ä¼˜åŒ–æŠ€å·§';
                } else if (currentModule === 'instruction') {
                    if (els.tipsTitle) els.tipsTitle.textContent = 'ä¼˜åŒ–æŠ€å·§';
                    if (els.tipsSubtitle) els.tipsSubtitle.textContent = 'ä½¿ç”¨å»ºè®®';

                    tips = [
                        'æ˜ç¡®çš„ç›®æ ‡å¯¼å‘',
                        'æ¸…æ™°çš„æ­¥éª¤æˆ–çº¦æŸæ¡ä»¶',
                        'å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯',
                        'ä¸“ä¸šçš„è¡¨è¾¾æ–¹å¼'
                    ];
                    title = 'ä¼˜åŒ–æŠ€å·§';
                } else if (currentModule === 'prompt') {
                    // æç¤ºè¯ä¼˜åŒ–ï¼ˆpromptï¼‰
                    if (els.tipsTitle) els.tipsTitle.textContent = 'æç¤ºè¯ä¼˜åŒ–æŠ€å·§';
                    if (els.tipsSubtitle) els.tipsSubtitle.textContent = 'æå‡ Prompt è´¨é‡çš„å»ºè®®';

                    tips = [
                        'æ˜ç¡®ä»»åŠ¡ç›®æ ‡å’Œè¾“å‡ºå½¢æ€ï¼Œä¾‹å¦‚â€œç”Ÿæˆæ­¥éª¤è¯´æ˜ / æ‹Ÿä¸€å°é‚®ä»¶ / å†™ä¸€æ®µä»£ç â€ã€‚',
                        'ç»™å‡ºå¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚é¢†åŸŸã€å—ä¼—ã€è¯­æ°”é£æ ¼ã€é•¿åº¦é™åˆ¶ç­‰ã€‚',
                        'ä½¿ç”¨åˆ†ç‚¹æˆ–åˆ—è¡¨çš„æ–¹å¼ç»„ç»‡éœ€æ±‚ï¼Œé¿å…é•¿å¥å †å å¯¼è‡´æ¨¡å‹è¯¯è§£ã€‚',
                        'æä¾› 1~2 ä¸ªç¤ºä¾‹ï¼Œè®©æ¨¡å‹å¯¹â€œå¥½è¾“å‡ºâ€çš„é£æ ¼å’Œç»†èŠ‚æœ‰ç›´è§‚è®¤è¯†ã€‚',
                        'å°†å¯å¤ç”¨çš„ Prompt æŠ½æˆé¢„è®¾ï¼Œåç»­åªæ›¿æ¢å…³é”®ä¿¡æ¯å³å¯å¿«é€Ÿè°ƒç”¨ã€‚'
                    ];
                    title = 'æç¤ºè¯ä¼˜åŒ–å»ºè®®';
                } else if (currentModule === 'prompt-helper') {
                    tips = [
                        'ç®€è¿°ç›®æ ‡ä¸å—ä¼—ï¼Œé¿å…æ— æ•ˆä¿¡æ¯',
                        'ä¸ºè¾“å‡ºæŒ‡å®šé£æ ¼ã€æ ¼å¼å’Œé•¿åº¦',
                        'è¡¥å……ä¸Šä¸‹æ–‡ä¸è¾¹ç•Œæ¡ä»¶ï¼Œå‡å°‘æ­§ä¹‰',
                        'æŠ½æˆå¯å¤ç”¨æ¨¡æ¿ï¼Œé™ä½é‡å¤åŠ³åŠ¨'
                    ];
                    title = 'å¸®å†™å»ºè®®';
                }

                tipsEl.innerHTML = tips.map(tip => `
                <div class="flex items-start gap-2">
                    <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500 mt-0.5 flex-shrink-0"></i>
                    <p>${tip}</p>
                </div>
            `).join('');

                scheduleIconsUpdate();
            }

            function resetPresetForm() {
                if (els.inputSystemPrompt) els.inputSystemPrompt.value = "";
                if (els.inputPresetName) els.inputPresetName.value = "";
                if (els.presetNameContainer) els.presetNameContainer.classList.remove('hidden');
                if (els.btnDeletePreset) els.btnDeletePreset.classList.add('hidden');
                if (els.btnCancelEdit) els.btnCancelEdit.classList.add('hidden');
                if (els.editorTitle) els.editorTitle.textContent = 'æ–°å»ºé¢„è®¾';
                if (els.btnSaveText) els.btnSaveText.textContent = 'ä¿å­˜é¢„è®¾';
                updateSaveButtonState();
                updatePresetCharCount();
            }

            function updateSaveButtonState() {
                const hasName = els.inputPresetName ? els.inputPresetName.value.trim().length > 0 : false;
                const hasContent = els.inputSystemPrompt ? els.inputSystemPrompt.value.trim().length > 0 : false;
                if (els.btnSavePreset) els.btnSavePreset.disabled = !(hasName && hasContent);
            }

            function updatePresetCharCount() {
                if (els.presetCharCount) {
                    const count = els.inputSystemPrompt ? els.inputSystemPrompt.value.length : 0;
                    els.presetCharCount.textContent = `${count} å­—ç¬¦`;
                }
            }

            async function handleOptimize() {
                const input = els.inputPrompt.value.trim();
                const presets = instructionPresets;

                // ä½¿ç”¨é»˜è®¤çš„ç³»ç»Ÿæç¤ºè¯ï¼ˆä¼˜å…ˆä½¿ç”¨ Active Presetï¼Œå¦åˆ™ä½¿ç”¨æ’åºåçš„ç¬¬ä¸€ä¸ªé¢„è®¾ï¼‰
                const defaultPresetKeys = Object.keys(presets).sort();
                let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªè¾…åŠ©ä¼˜åŒ–çš„ä¸“å®¶ã€‚';

                const active = activePresets[currentModule];
                if (active && presets[active]) {
                    systemPrompt = presets[active];
                } else if (defaultPresetKeys.length > 0) {
                    systemPrompt = presets[defaultPresetKeys[0]];
                }

                if (!input) { showToast('è¯·è¾“å…¥è¦ä¼˜åŒ–çš„å†…å®¹', 'error'); return; }
                if (!appConfig.apiKey) {
                    showToast('è®¾ç½®ä¸­ç¼ºå°‘ LLM API å¯†é’¥', 'error');
                    els.settingsModal.classList.remove('hidden');
                    return;
                }

                // æ›´æ–°ä½¿ç”¨äººæ•°ç»Ÿè®¡
                updateUsageCount();

                setLoading(true);
                try {
                    if (isStepPreset(systemPrompt)) {
                        const step1Messages = [
                            { role: 'system', content: systemPrompt.step1 || 'è¯·è¾“å‡ºä¼˜åŒ–åçš„æŒ‡ä»¤' },
                            { role: 'user', content: input }
                        ];
                        const step1Result = await chatRequest(step1Messages, 0.7);
                        els.outputPrompt.value = step1Result || '';
                        if (els.outputCharCount) els.outputCharCount.textContent = `${(els.outputPrompt.value || '').length} å­—ç¬¦`;
                        els.outputPrompt.classList.remove('hidden');
                        els.outputPlaceholder.classList.add('hidden');
                        els.outputIndicator.classList.remove('hidden');
                        els.btnCopy.disabled = false;
                        if (els.reasoningCard && els.reasoningContent) {
                            const step2Messages = [
                                { role: 'system', content: systemPrompt.step2 || 'è¯·è¾“å‡ºä¼˜åŒ–æ€è·¯' },
                                { role: 'user', content: `åŸå§‹æŒ‡ä»¤ï¼š\n${input}\n\nä¼˜åŒ–ç»“æœï¼š\n${step1Result}\n\nè¯·ä»…è¾“å‡ºä¼˜åŒ–æ€è·¯` }
                            ];
                            const step2Reasoning = await chatRequest(step2Messages, 0.7);
                            els.reasoningContent.textContent = step2Reasoning || '';
                            els.reasoningCard.classList.remove('hidden');
                        }
                        showToast('ä¼˜åŒ–å®Œæˆï¼', 'success');
                    } else {
                        const fullResponse = await optimizeApiCall(input, systemPrompt);
                        const parsed = parseOptimizationResponse(fullResponse);
                        if (els.reasoningCard && els.reasoningContent) {
                            els.reasoningContent.textContent = parsed.reasoning || '';
                            els.reasoningCard.classList.remove('hidden');
                        }
                        els.outputPrompt.value = parsed.result;
                        if (els.outputCharCount) els.outputCharCount.textContent = `${(els.outputPrompt.value || '').length} å­—ç¬¦`;
                        els.outputPrompt.classList.remove('hidden');
                        els.outputPlaceholder.classList.add('hidden');
                        els.outputIndicator.classList.remove('hidden');
                        els.btnCopy.disabled = false;
                        showToast('ä¼˜åŒ–å®Œæˆï¼', 'success');
                    }
                } catch (error) {
                    showToast(error.message || 'ä¼˜åŒ–å¤±è´¥', 'error');
                } finally {
                    setLoading(false);
                }
            }

            function setLoadingHelper(isLoading) {
                if (!els.btnOptimizeHelper) return;
                els.btnOptimizeHelper.disabled = isLoading;
                if (isLoading) {
                    if (els.iconOptimizeHelper) els.iconOptimizeHelper.classList.add('hidden');
                    if (els.iconArrowHelper) els.iconArrowHelper.classList.add('hidden');
                    if (els.iconLoadingHelper) els.iconLoadingHelper.classList.remove('hidden');
                    if (els.btnTextHelper) els.btnTextHelper.textContent = 'æ­£åœ¨å¸®å†™...';
                } else {
                    if (els.iconOptimizeHelper) els.iconOptimizeHelper.classList.remove('hidden');
                    if (els.iconArrowHelper) els.iconArrowHelper.classList.remove('hidden');
                    if (els.iconLoadingHelper) els.iconLoadingHelper.classList.add('hidden');
                    if (els.btnTextHelper) els.btnTextHelper.textContent = 'å¼€å§‹å¸®å†™';
                }
            }

            async function handlePromptHelperOptimize() {
                const input = (els.inputPromptHelper && els.inputPromptHelper.value.trim()) || '';
                const presets = promptHelperPresets;
                const defaultPresetKeys = Object.keys(presets).sort();
                let systemPrompt = 'ä½ æ˜¯ä¸€åæç¤ºè¯å¸®å†™ä¸“å®¶ã€‚';
                const active = activePresets['prompt-helper'];
                if (active && presets[active]) {
                    systemPrompt = presets[active];
                } else if (defaultPresetKeys.length > 0) {
                    systemPrompt = presets[defaultPresetKeys[0]];
                }

                if (!input) { showToast('è¯·è¾“å…¥åŸå§‹å†…å®¹', 'error'); return; }
                if (!appConfig.apiKey) {
                    showToast('è®¾ç½®ä¸­ç¼ºå°‘ LLM API å¯†é’¥', 'error');
                    els.settingsModal.classList.remove('hidden');
                    return;
                }

                // æ›´æ–°ä½¿ç”¨äººæ•°ç»Ÿè®¡
                updateUsageCount();

                setLoadingHelper(true);
                try {
                    if (isStepPreset(systemPrompt)) {
                        const step1Messages = [
                            { role: 'system', content: systemPrompt.step1 || 'è¯·è¾“å‡ºä¼˜åŒ–åçš„æç¤ºè¯' },
                            { role: 'user', content: input }
                        ];
                        const step1Result = await chatRequest(step1Messages, 0.7);
                        if (els.outputPromptHelper) els.outputPromptHelper.value = step1Result || '';
                        if (els.outputCharCountHelper) els.outputCharCountHelper.textContent = `${(els.outputPromptHelper && els.outputPromptHelper.value || '').length} å­—ç¬¦`;
                        if (els.outputPromptHelper) els.outputPromptHelper.classList.remove('hidden');
                        if (els.outputPlaceholderHelper) els.outputPlaceholderHelper.classList.add('hidden');
                        if (els.outputIndicatorHelper) els.outputIndicatorHelper.classList.remove('hidden');
                        if (els.btnCopyHelper) els.btnCopyHelper.disabled = false;
                        if (els.reasoningCardHelper && els.reasoningContentHelper) {
                            const step2Messages = [
                                { role: 'system', content: systemPrompt.step2 || 'è¯·è¾“å‡ºå¸®å†™æ€è·¯' },
                                { role: 'user', content: `åŸå§‹è¾“å…¥ï¼š\n${input}\n\nä¼˜åŒ–ç»“æœï¼š\n${step1Result}\n\nè¯·ä»…è¾“å‡ºå¸®å†™æ€è·¯` }
                            ];
                            const step2Reasoning = await chatRequest(step2Messages, 0.7);
                            els.reasoningContentHelper.textContent = step2Reasoning || '';
                            els.reasoningCardHelper.classList.remove('hidden');
                        }
                        showToast('å¸®å†™å®Œæˆï¼', 'success');
                    } else {
                        const fullResponse = await optimizeApiCall(input, systemPrompt);
                        const parsed = parseOptimizationResponse(fullResponse);
                        if (els.reasoningCardHelper && els.reasoningContentHelper) {
                            els.reasoningContentHelper.textContent = parsed.reasoning || '';
                            els.reasoningCardHelper.classList.remove('hidden');
                        }
                        if (els.outputPromptHelper) els.outputPromptHelper.value = parsed.result;
                        if (els.outputCharCountHelper) els.outputCharCountHelper.textContent = `${(els.outputPromptHelper && els.outputPromptHelper.value || '').length} å­—ç¬¦`;
                        if (els.outputPromptHelper) els.outputPromptHelper.classList.remove('hidden');
                        if (els.outputPlaceholderHelper) els.outputPlaceholderHelper.classList.add('hidden');
                        if (els.outputIndicatorHelper) els.outputIndicatorHelper.classList.remove('hidden');
                        if (els.btnCopyHelper) els.btnCopyHelper.disabled = false;
                        showToast('å¸®å†™å®Œæˆï¼', 'success');
                    }
                } catch (error) {
                    showToast(error.message || 'å¸®å†™å¤±è´¥', 'error');
                } finally {
                    setLoadingHelper(false);
                }
            }

            function setLoading(isLoading) {
                isOptimizing = isLoading;
                els.btnOptimize.disabled = isLoading;
                if (isLoading) {
                    els.iconOptimize.classList.add('hidden');
                    els.iconArrow.classList.add('hidden');
                    els.iconLoading.classList.remove('hidden');
                    els.btnText.textContent = 'æ­£åœ¨ä¼˜åŒ–...';
                } else {
                    els.iconOptimize.classList.remove('hidden');
                    els.iconArrow.classList.remove('hidden');
                    els.iconLoading.classList.add('hidden');
                    els.btnText.textContent = 'å¼€å§‹ä¼˜åŒ–';
                }
            }

            async function optimizeApiCall(input, systemPrompt) {
                const finalSystemPrompt = systemPrompt || 'ä½ æ˜¯ä¸€ä¸ªè¾…åŠ©ä¼˜åŒ–çš„ä¸“å®¶ã€‚';
                const isGemini = appConfig.baseURL.includes('googleapis.com');

                let url, headers, body;

                if (isGemini) {
                    url = `${appConfig.baseURL}/chat/completions?key=${appConfig.apiKey}`;
                    headers = { 'Content-Type': 'application/json' };
                } else {
                    url = `${appConfig.baseURL}/chat/completions`;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${appConfig.apiKey}`
                    };
                }

                body = JSON.stringify({
                    model: appConfig.model,
                    messages: [
                        { role: 'system', content: finalSystemPrompt },
                        { role: 'user', content: input }
                    ],
                    temperature: 0.7
                });

                // ç›´æ¥ä½¿ç”¨åŸå§‹URLï¼Œä¸ä½¿ç”¨CORSä»£ç†
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: body
                });
                if (!response.ok) throw new Error(`API é”™è¯¯: ${response.status}`);
                const data = await response.json();
                return data.choices[0]?.message?.content?.trim() || '';
            }

            function supportsImagesBase() {
                const model = (appConfig.model || '').trim().toLowerCase();
                // Check widely known models that support vision
                if (model.includes('gpt-4o') ||
                    model.includes('gpt-4-turbo') ||
                    model.includes('gpt-4-vision') ||
                    model.includes('gemini') ||
                    model.includes('claude-3') ||
                    model.includes('vl') || // often used in open weights models like Qwen-VL
                    model.includes('vision') ||
                    model.includes('doubao') ||
                    model === '4a0f0df9-0108-4585-b794-cadf6b52cc60') {
                    return true;
                }
                return false;
            }

            async function chatRequest(messages, temperature = 0.7) {
                console.log('Sending chatRequest:', { model: appConfig.model, messages, temperature });
                const isGemini = appConfig.baseURL.includes('googleapis.com');
                let url, headers, body;

                if (isGemini) {
                    url = `${appConfig.baseURL}/chat/completions?key=${appConfig.apiKey}`;
                    headers = { 'Content-Type': 'application/json' };
                } else {
                    url = `${appConfig.baseURL}/chat/completions`;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${appConfig.apiKey}`
                    };
                }

                body = JSON.stringify({
                    model: appConfig.model,
                    messages: messages,
                    temperature: temperature
                });

                try {
                    // ç›´æ¥ä½¿ç”¨åŸå§‹URLï¼Œä¸ä½¿ç”¨CORSä»£ç†
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: headers,
                        body: body
                    });

                    console.log('API Response Status:', response.status);

                    if (!response.ok) {
                        let errorMsg = `API è¯·æ±‚å¤±è´¥: ${response.status}`;
                        try {
                            const errData = await response.json();
                            console.error('API Error Data:', errData);
                            if (errData.error && errData.error.message) {
                                errorMsg += ` - ${errData.error.message}`;
                            } else if (errData.message) {
                                errorMsg += ` - ${errData.message}`;
                            }
                        } catch (e) {
                            console.error('Failed to parse error response:', e);
                        }
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    console.log('API Success Data:', data);
                    return data.choices[0]?.message?.content?.trim() || '';
                } catch (error) {
                    console.error('Fetch Error:', error);
                    throw error;
                }
            }

            // Image Reverse Functions
            async function handleImageUpload(file) {
                if (!file.type.startsWith('image/')) {
                    showToast('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'error');
                    return;
                }

                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showToast('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº 10MB çš„å›¾ç‰‡', 'error');
                    return;
                }

                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImageBase64 = e.target.result;
                        els.imagePreview.src = uploadedImageBase64;
                        els.imageDropzone.classList.add('hidden');
                        els.imagePreviewContainer.classList.remove('hidden');
                        els.btnClearImage.classList.remove('hidden');
                        els.btnReverse.disabled = false;
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    showToast('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                }
            }

            // Instruction Reverse Functions
            async function handleImageUpload1(file) {
                if (!file.type.startsWith('image/')) {
                    showToast('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'error');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    showToast('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº 10MB çš„å›¾ç‰‡', 'error');
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImage1Base64 = e.target.result;
                        els.imagePreview1.src = uploadedImage1Base64;
                        els.imageDropzone1.classList.add('hidden');
                        els.imagePreviewContainer1.classList.remove('hidden');
                        els.btnClearImage1.classList.remove('hidden');
                        updateOptimizeButtonState();
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    showToast('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                }
            }

            async function handleImageUpload2(file) {
                if (!file.type.startsWith('image/')) {
                    showToast('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'error');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    showToast('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ å°äº 10MB çš„å›¾ç‰‡', 'error');
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImage2Base64 = e.target.result;
                        els.imagePreview2.src = uploadedImage2Base64;
                        els.imageDropzone2.classList.add('hidden');
                        els.imagePreviewContainer2.classList.remove('hidden');
                        els.btnClearImage2.classList.remove('hidden');
                        updateOptimizeButtonState();
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    showToast('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                }
            }

            function updateOptimizeButtonState() {
                if (els.btnOptimizeInstructionReverse) {
                    const hasText = els.inputInstructionReverseText && els.inputInstructionReverseText.value.trim().length > 0;
                    els.btnOptimizeInstructionReverse.disabled = !(uploadedImage1Base64 && uploadedImage2Base64 && hasText);
                }
            }

            async function handleInstructionReverse() {
                if (!uploadedImage1Base64 || !uploadedImage2Base64) {
                    showToast('è¯·ä¸Šä¼ ä¸¤å¼ å›¾ç‰‡', 'error');
                    return;
                }

                if (!appConfig.apiKey) {
                    showToast('è®¾ç½®ä¸­ç¼ºå°‘ LLM API å¯†é’¥', 'error');
                    els.settingsModal.classList.remove('hidden');
                    return;
                }

                const presets = instructionReversePresets;
                const defaultPresetKeys = Object.keys(presets).sort();
                let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒå¯¹æ¯”åˆ†æä¸“å®¶ã€‚è¯·ä»”ç»†åˆ†æä¸¤å¼ å›¾ç‰‡ï¼Œè¯†åˆ«å®ƒä»¬çš„ç›¸ä¼¼ä¹‹å¤„å’Œå·®å¼‚ä¹‹å¤„ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„æŒ‡ä»¤æè¿°ã€‚';

                const active = activePresets['instruction-reverse'];
                if (active && presets[active]) {
                    systemPrompt = presets[active];
                } else if (defaultPresetKeys.length > 0) {
                    systemPrompt = presets[defaultPresetKeys[0]];
                }

                // æ›´æ–°ä½¿ç”¨äººæ•°ç»Ÿè®¡
                updateUsageCount();

                setLoadingInstructionReverse(true);
                try {
                    const supportsImages = supportsImagesBase();
                    let result = '';
                    if (supportsImages) {
                        const userText = (els.inputInstructionReverseText && els.inputInstructionReverseText.value.trim()) || 'åˆ†æä¸¤å¼ å›¾ç‰‡å¹¶ç”Ÿæˆè¯¦ç»†æŒ‡ä»¤';
                        const messages = [
                            { role: 'system', content: systemPrompt },
                            {
                                role: 'user', content: [
                                    { type: 'text', text: userText },
                                    { type: 'image_url', image_url: { url: uploadedImage1Base64 } },
                                    { type: 'image_url', image_url: { url: uploadedImage2Base64 } }
                                ]
                            }
                        ];
                        result = await chatRequest(messages, 0.7);
                    } else {
                        const imageInfo = `æˆ‘å·²ç»ä¸Šä¼ äº†ä¸¤å¼ å›¾ç‰‡ï¼Œè¯·æ ¹æ®ä»¥ä¸‹é¢„è®¾è§„åˆ™åˆ†æè¿™ä¸¤å¼ å›¾ç‰‡å¹¶ç”ŸæˆæŒ‡ä»¤ï¼š\n\né¢„è®¾è§„åˆ™ï¼š${systemPrompt}\n\nè¯·åŸºäºä»¥ä¸‹å›¾ç‰‡ä¿¡æ¯è¿›è¡Œåˆ†æï¼š\n- å›¾ç‰‡1ï¼šå·²ä¸Šä¼ ï¼ˆBase64æ ¼å¼ï¼‰\n- å›¾ç‰‡2ï¼šå·²ä¸Šä¼ ï¼ˆBase64æ ¼å¼ï¼‰\n\nç”±äºå½“å‰ API ä¸æ”¯æŒç›´æ¥å¤„ç†å›¾ç‰‡ï¼Œè¯·æ ¹æ®é¢„è®¾è§„åˆ™ç”Ÿæˆä¸€ä¸ªé€šç”¨çš„æŒ‡ä»¤æ¨¡æ¿ï¼Œè¯¥æ¨¡æ¿åº”è¯¥èƒ½å¤ŸæŒ‡å¯¼å¦‚ä½•ä»å›¾ç‰‡1çš„æ•ˆæœè½¬æ¢åˆ°å›¾ç‰‡2çš„æ•ˆæœã€‚`;
                        const userText = (els.inputInstructionReverseText && els.inputInstructionReverseText.value.trim()) || '';
                        const combined = userText ? `${imageInfo}\n\nç”¨æˆ·è¾“å…¥ï¼š${userText}` : imageInfo;
                        const messages = [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: combined }
                        ];
                        result = await chatRequest(messages, 0.7);
                    }

                    if (!result) {
                        throw new Error('API è¿”å›ç»“æœä¸ºç©ºï¼Œè¯·æ£€æŸ¥ API é…ç½®å’Œç½‘ç»œè¿æ¥');
                    }

                    // ç¡®ä¿è¾“å‡ºåŒºåŸŸæ­£ç¡®æ˜¾ç¤º
                    els.outputInstructionReverse.value = result;
                    els.outputInstructionReverse.classList.remove('hidden');
                    els.outputPlaceholderInstructionReverse.classList.add('hidden');
                    els.outputIndicatorInstructionReverse.classList.remove('hidden');
                    els.btnCopyInstructionReverse.disabled = false;

                    // å¼ºåˆ¶åˆ·æ–°æ˜¾ç¤º
                    els.outputInstructionReverse.style.display = 'block';
                    els.outputPlaceholderInstructionReverse.style.display = 'none';

                    if (!supportsImages) {
                        showToast('ä¼˜åŒ–å®Œæˆï¼ï¼ˆæ³¨æ„ï¼šå½“å‰ API ä¸æ”¯æŒå›¾ç‰‡è¾“å…¥ï¼Œå·²ä½¿ç”¨æ–‡æœ¬æ¨¡å¼ï¼‰', 'success');
                    } else {
                        showToast('ä¼˜åŒ–å®Œæˆï¼', 'success');
                    }
                } catch (error) {
                    console.error('æŒ‡ä»¤åæ¨é”™è¯¯:', error);
                    showToast(error.message || 'ä¼˜åŒ–å¤±è´¥', 'error');
                    // ç¡®ä¿é”™è¯¯æ—¶ä¹Ÿéšè— placeholder
                    els.outputPlaceholderInstructionReverse.classList.add('hidden');
                } finally {
                    setLoadingInstructionReverse(false);
                }
            }

            function setLoadingInstructionReverse(isLoading) {
                if (!els.btnOptimizeInstructionReverse) return;
                isOptimizing = isLoading;
                els.btnOptimizeInstructionReverse.disabled = isLoading;
                if (isLoading) {
                    els.iconOptimizeInstructionReverse.classList.add('hidden');
                    els.iconArrowInstructionReverse.classList.add('hidden');
                    els.iconLoadingInstructionReverse.classList.remove('hidden');
                    els.btnTextInstructionReverse.textContent = 'æ­£åœ¨ä¼˜åŒ–...';
                } else {
                    els.iconOptimizeInstructionReverse.classList.remove('hidden');
                    els.iconArrowInstructionReverse.classList.remove('hidden');
                    els.iconLoadingInstructionReverse.classList.add('hidden');
                    els.btnTextInstructionReverse.textContent = 'å¼€å§‹ä¼˜åŒ–';
                }
            }

            async function handleImageReverse() {
                if (!uploadedImageBase64) {
                    showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
                    return;
                }

                if (!appConfig.apiKey) {
                    showToast('è®¾ç½®ä¸­ç¼ºå°‘ LLM API å¯†é’¥', 'error');
                    els.settingsModal.classList.remove('hidden');
                    return;
                }

                const presets = imageReversePresets;
                const defaultPresetKeys = Object.keys(presets).sort();
                let systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾åƒåˆ†æä¸“å®¶ã€‚è¯·è¯¦ç»†æè¿°è¿™å¼ å›¾ç‰‡ã€‚';

                const active = activePresets['image-reverse'];
                if (active && presets[active]) {
                    systemPrompt = presets[active];
                } else if (defaultPresetKeys.length > 0) {
                    systemPrompt = presets[defaultPresetKeys[0]];
                }

                // æ›´æ–°ä½¿ç”¨äººæ•°ç»Ÿè®¡
                updateUsageCount();

                setLoadingImage(true);
                try {
                    const supportsImages = supportsImagesBase();
                    console.log('Supports Images:', supportsImages);
                    let result = '';
                    if (supportsImages) {
                        const messages = [
                            { role: 'system', content: systemPrompt },
                            {
                                role: 'user', content: [
                                    { type: 'text', text: 'æè¿°è¿™å¼ å›¾ç‰‡' },
                                    { type: 'image_url', image_url: { url: uploadedImageBase64 } }
                                ]
                            }
                        ];
                        result = await chatRequest(messages, 0.7);
                    } else {
                        const imageInfo = `æˆ‘å·²ç»ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·æ ¹æ®ä»¥ä¸‹é¢„è®¾è§„åˆ™åˆ†æè¿™å¼ å›¾ç‰‡å¹¶ç”Ÿæˆæè¿°ï¼š\n\né¢„è®¾è§„åˆ™ï¼š${systemPrompt}\n\nç”±äºå½“å‰ API ä¸æ”¯æŒç›´æ¥å¤„ç†å›¾ç‰‡ï¼Œè¯·æ ¹æ®é¢„è®¾è§„åˆ™ç”Ÿæˆä¸€ä¸ªé€šç”¨çš„å›¾ç‰‡æè¿°æ¨¡æ¿ã€‚`;
                        const messages = [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: imageInfo }
                        ];
                        result = await chatRequest(messages, 0.7);
                    }

                    console.log('Result from API:', result);

                    els.outputImagePrompt.value = result;
                    els.outputImagePrompt.classList.remove('hidden');
                    els.outputPlaceholderImage.classList.add('hidden');
                    els.outputIndicatorImage.classList.remove('hidden');
                    els.btnCopyImage.disabled = false;

                    if (!supportsImages) {
                        showToast('åæ¨å®Œæˆï¼ï¼ˆæ³¨æ„ï¼šå½“å‰ API ä¸æ”¯æŒå›¾ç‰‡è¾“å…¥ï¼Œå·²ä½¿ç”¨æ–‡æœ¬æ¨¡å¼ï¼‰', 'success');
                    } else {
                        showToast('åæ¨å®Œæˆï¼', 'success');
                    }
                } catch (error) {
                    console.error('Handle Image Reverse Error:', error);
                    showToast(error.message || 'åæ¨å¤±è´¥', 'error');
                } finally {
                    setLoadingImage(false);
                }
            }

            function setLoadingImage(isLoading) {
                els.btnReverse.disabled = isLoading || !uploadedImageBase64;
                if (isLoading) {
                    els.iconReverse.classList.add('hidden');
                    els.iconArrowImage.classList.add('hidden');
                    els.iconLoadingImage.classList.remove('hidden');
                    els.btnTextImage.textContent = 'æ­£åœ¨åæ¨...';
                } else {
                    els.iconReverse.classList.remove('hidden');
                    els.iconArrowImage.classList.remove('hidden');
                    els.iconLoadingImage.classList.add('hidden');
                    els.btnTextImage.textContent = 'åæ¨æç¤ºè¯';
                }
            }

            // Initialization
            document.addEventListener('DOMContentLoaded', () => {
                loadConfig();
                loadPresets();
                try {
                    const storedModule = localStorage.getItem(CURRENT_MODULE_KEY);
                    if (storedModule) currentModule = storedModule;
                } catch (e) { }
                const usp = new URLSearchParams(window.location.search);
                if (usp.get('reset_presets') === '1') {
                    clearAllPresets();
                }
                setupEventListeners();
                // ç¡®ä¿ currentModule æœ‰é»˜è®¤å€¼
                if (!currentModule) {
                    currentModule = 'prompt';
                }
                switchTab(currentModule);
                // switchTab å†…éƒ¨å·²ç»è°ƒç”¨äº† updateSidebarPreset() å’Œ updateSidebarTips()
                // åˆå§‹åŒ–ä½¿ç”¨äººæ•°ç»Ÿè®¡
                initUsageCount();
                // å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨åŠ è½½
                setTimeout(() => {
                    updateSidebarTips(); // ç¡®ä¿æŠ€å·§æ˜¾ç¤º
                    scheduleIconsUpdate();
                }, 100);
            });

            function showToast(message, type) {
                els.toastMessage.textContent = message;

                const iconId = `toast-icon-${Date.now()}`;
                const iconName = type === 'success' ? 'check-circle-2' : 'alert-circle';
                const iconColor = type === 'success' ? 'text-emerald-500' : 'text-red-500';
                const borderClass = type === 'success' ? 'border-emerald-100 text-emerald-800' : 'border-red-100 text-red-800';

                els.toastContent.className = `flex items-center gap-3 px-6 py-4 rounded-xl shadow-2xl border bg-white/90 backdrop-blur-md transition-all ${borderClass}`;
                els.toastIcon.innerHTML = `<i data-lucide="${iconName}" class="w-6 h-6 ${iconColor}"></i>`;

                scheduleIconsUpdate();

                els.toast.classList.remove('translate-y-24', 'opacity-0');

                // If it's an error, also log it clearly in the console
                if (type === 'error') {
                    console.error('TOAST ERROR:', message);
                }

                // Clear previous timeout if any
                if (window.toastTimeout) clearTimeout(window.toastTimeout);

                window.toastTimeout = setTimeout(() => {
                    els.toast.classList.add('translate-y-24', 'opacity-0');
                }, 6000); // Extended to 6 seconds for better readability of complex errors
            }

            // Universal Error Catcher
            window.onerror = function (message, source, lineno, colno, error) {
                console.error('Global JS Error:', { message, source, lineno, colno, error });
                showToast(`ç³»ç»Ÿç¨‹åºé”™è¯¯: ${message}`, 'error');
                return false;
            };

            window.onunhandledrejection = function (event) {
                console.error('Unhandled Promise Rejection:', event.reason);
                showToast(`ç½‘ç»œæˆ–å¼‚æ­¥è¯·æ±‚é”™è¯¯: ${event.reason.message || event.reason}`, 'error');
            };
        </script>
</body>

</html>
